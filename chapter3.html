<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬3ç« ï¼šNPUç³»ç»Ÿæ¶æ„ - NPUè®¾è®¡æ•™ç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .nav-bar {
            background: #34495e;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-bar ul {
            list-style: none;
            display: flex;
            justify-content: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
        }

        .nav-bar li {
            margin: 0 15px;
        }

        .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .nav-bar a:hover {
            background: #2c3e50;
        }

        .nav-bar .current {
            background: #2c3e50;
            font-weight: bold;
        }

        .chapter {
            background: white;
            margin: 20px 0;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chapter h2 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .chapter h3 {
            color: #34495e;
            font-size: 1.5em;
            margin: 25px 0 15px 0;
        }

        .chapter h4 {
            color: #7f8c8d;
            font-size: 1.2em;
            margin: 20px 0 10px 0;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }
        
        /* Language label */
        .code-block::before {
            content: attr(data-language);
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: #95a5a6;
            text-transform: uppercase;
        }
        
        /* Syntax highlighting classes */
        .code-block .keyword { color: #e74c3c; font-weight: bold; }
        .code-block .type { color: #3498db; }
        .code-block .comment { color: #95a5a6; font-style: italic; }
        .code-block .number { color: #e67e22; }
        .code-block .string { color: #2ecc71; }
        .code-block .function { color: #3498db; }

        .exercise {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
        }

        .exercise h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .question {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .answer {
            margin-top: 10px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 5px;
            display: none;
            border-left: 4px solid #4caf50;
        }

        .answer.show {
            display: block;
        }
        
        .hint {
            margin: 10px 0;
            padding: 10px 15px;
            background: #fff8dc;
            border-left: 4px solid #ffa500;
            border-radius: 5px;
            font-size: 0.95em;
        }
        
        .hint summary {
            cursor: pointer;
            font-weight: bold;
            color: #ff8c00;
            outline: none;
        }
        
        .hint summary:hover {
            color: #ff6347;
        }
        
        .hint p {
            margin-top: 10px;
            color: #666;
        }

        .toggle-answer {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .toggle-answer:hover {
            background: #2980b9;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 5px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 5px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .chapter-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }

        .chapter-nav a {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .chapter-nav a:hover {
            background: #2980b9;
        }

        .chapter-nav .prev::before {
            content: "â† ";
        }

        .chapter-nav .next::after {
            content: " â†’";
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 20px 10px;
            }
            
            header h1 {
                font-size: 1.5em;
            }
            
            .chapter {
                padding: 15px;
                margin: 10px 0;
            }
            
            .chapter h2 {
                font-size: 1.5em;
            }
            
            .chapter h3 {
                font-size: 1.2em;
            }
            
            .nav-bar ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-bar li {
                margin: 5px;
            }
            
            .code-block {
                padding: 10px;
                font-size: 12px;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px;
            }
        }

        /* List styles for proper indentation */
        .chapter ul, .chapter ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .chapter li {
            margin-bottom: 8px;
            line-height: 1.8;
        }
        
        .chapter ul ul, .chapter ol ol, .chapter ul ol, .chapter ol ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .info-box ul, .warning-box ul, .answer ul {
            margin-left: 20px;
        }
        
        .info-box li, .warning-box li, .answer li {
            margin-bottom: 10px;
        }
        
        /* Keep nav-bar lists unstyled */
        .nav-bar ul {
            margin-left: 0;
        }
        
        .nav-bar li {
            margin-bottom: 0;
        }
    </style>
    <script>
        // Syntax highlighting functions
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        function highlightSyntax() {
            const codeBlocks = document.querySelectorAll('.code-block');
            
            codeBlocks.forEach(block => {
                const content = block.textContent;
                let language = 'text';
                let highlighted = content;
                
                // Auto-detect language based on content
                if (content.includes('module ') || content.includes('always @') || content.includes('wire ') || content.includes('reg ')) {
                    language = 'verilog';
                    highlighted = highlightVerilog(content);
                } else if (content.includes('import ') || content.includes('def ') || content.includes('class ')) {
                    language = 'python';
                    highlighted = highlightPython(content);
                }
                
                block.innerHTML = highlighted;
                block.classList.add(language);
                block.setAttribute('data-language', language);
            });
        }
        
        function highlightVerilog(code) {
            const placeholders = [];
            let placeholderIndex = 0;
            
            // Replace comments with placeholders
            code = code.replace(/(\/\/.*$|\/\*[\s\S]*?\*\/)/gm, (match) => {
                const placeholder = `__COMMENT_${placeholderIndex}__`;
                placeholders[placeholderIndex] = `<span class="comment">${escapeHtml(match)}</span>`;
                placeholderIndex++;
                return placeholder;
            });
            
            // Replace strings with placeholders
            code = code.replace(/("[^"]*")/g, (match) => {
                const placeholder = `__STRING_${placeholderIndex}__`;
                placeholders[placeholderIndex] = `<span class="string">${escapeHtml(match)}</span>`;
                placeholderIndex++;
                return placeholder;
            });
            
            // Apply highlights
            const keywords = /\b(module|endmodule|input|output|wire|reg|always|assign|begin|end|if|else|for|while|parameter|posedge|negedge)\b/g;
            const types = /\b(bit|logic|byte|shortint|int|longint|integer|time|real)\b/g;
            const numbers = /\b(\d+'[hbdo][\da-fA-F_]+|\d+)\b/g;
            
            code = code.replace(keywords, '<span class="keyword">$1</span>');
            code = code.replace(types, '<span class="type">$1</span>');
            code = code.replace(numbers, '<span class="number">$1</span>');
            
            // Restore placeholders
            for (let i = 0; i < placeholderIndex; i++) {
                code = code.replace(new RegExp(`__COMMENT_${i}__`, 'g'), placeholders[i]);
                code = code.replace(new RegExp(`__STRING_${i}__`, 'g'), placeholders[i]);
            }
            
            return code;
        }
        
        function highlightPython(code) {
            const placeholders = [];
            let placeholderIndex = 0;
            
            // Replace comments
            code = code.replace(/(#.*$)/gm, (match) => {
                const placeholder = `__COMMENT_${placeholderIndex}__`;
                placeholders[placeholderIndex] = `<span class="comment">${escapeHtml(match)}</span>`;
                placeholderIndex++;
                return placeholder;
            });
            
            // Replace strings
            code = code.replace(/("[^"]*"|'[^']*')/g, (match) => {
                const placeholder = `__STRING_${placeholderIndex}__`;
                placeholders[placeholderIndex] = `<span class="string">${escapeHtml(match)}</span>`;
                placeholderIndex++;
                return placeholder;
            });
            
            // Apply highlights
            const keywords = /\b(and|as|assert|break|class|continue|def|del|elif|else|except|False|finally|for|from|global|if|import|in|is|lambda|None|not|or|pass|raise|return|True|try|while|with|yield)\b/g;
            const builtins = /\b(abs|all|any|bin|bool|dict|float|format|hex|input|int|len|list|map|max|min|open|print|range|round|set|sorted|str|sum|tuple|type|zip)\b/g;
            const numbers = /\b(\d+\.?\d*)\b/g;
            
            code = code.replace(keywords, '<span class="keyword">$1</span>');
            code = code.replace(builtins, '<span class="function">$1</span>');
            code = code.replace(numbers, '<span class="number">$1</span>');
            
            // Restore placeholders
            for (let i = 0; i < placeholderIndex; i++) {
                code = code.replace(new RegExp(`__COMMENT_${i}__`, 'g'), placeholders[i]);
                code = code.replace(new RegExp(`__STRING_${i}__`, 'g'), placeholders[i]);
            }
            
            return code;
        }
        
        // Toggle answer visibility
        document.addEventListener('DOMContentLoaded', function() {
            highlightSyntax();
            
            const toggleButtons = document.querySelectorAll('.toggle-answer');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const answer = this.nextElementSibling;
                    answer.classList.toggle('show');
                    this.textContent = answer.classList.contains('show') ? 'éšè—ç­”æ¡ˆ' : 'æ˜¾ç¤ºç­”æ¡ˆ';
                });
            });
        });
    </script>
</head>
<body>
    <header>
        <h1>ç¬¬3ç« ï¼šNPUç³»ç»Ÿæ¶æ„</h1>
    </header>
    
    <nav class="nav-bar">
        <ul>
            <li><a href="index.html">é¦–é¡µ</a></li>
            <li><a href="chapter1.html">ç¬¬1ç« </a></li>
            <li><a href="chapter2.html">ç¬¬2ç« </a></li>
            <li><a href="chapter3.html" class="current">ç¬¬3ç« </a></li>
            <li><a href="chapter4.html">ç¬¬4ç« </a></li>
            <li><a href="chapter5.html">ç¬¬5ç« </a></li>
            <li><a href="chapter6.html">ç¬¬6ç« </a></li>
            <li><a href="chapter7.html">ç¬¬7ç« </a></li>
            <li><a href="chapter8.html">ç¬¬8ç« </a></li>
            <li><a href="chapter9.html">ç¬¬9ç« </a></li>
            <li><a href="chapter10.html">ç¬¬10ç« </a></li>
            <li><a href="chapter11.html">ç¬¬11ç« </a></li>
            <li><a href="chapter12.html">ç¬¬12ç« </a></li>
        </ul>
    </nav>
    
    <div class="container">
        <div class="chapter">
            <h2>ç¬¬3ç« ï¼šNPUç³»ç»Ÿæ¶æ„</h2>
            
            <h3>3.1 æ•´ä½“æ¶æ„è®¾è®¡</h3>
            
            <h4>3.1.1 NPUç³»ç»Ÿç»„æˆ</h4>
            <p>ç°ä»£NPUç³»ç»Ÿé€šå¸¸åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š</p>
            
            <div class="code-block">
NPUç³»ç»Ÿæ¶æ„å±‚æ¬¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Host Interface (PCIe/AXI)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Command Processor & Scheduler    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Compute â”‚  â”‚ Memory  â”‚  â”‚  DMA    â”‚ â”‚
â”‚  â”‚ Cluster â”‚  â”‚ System  â”‚  â”‚ Engine  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         On-chip Interconnect (NoC)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         External Memory Interface        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>

            <h4>3.1.2 è®¾è®¡è€ƒè™‘å› ç´ </h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾è®¡ç»´åº¦</th>
                            <th>å…³é”®æŒ‡æ ‡</th>
                            <th>æ¶æ„å½±å“</th>
                            <th>ä¼˜åŒ–æ–¹å‘</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ç®—åŠ›</td>
                            <td>TOPS/TFLOPS</td>
                            <td>MACé˜µåˆ—è§„æ¨¡</td>
                            <td>å¢åŠ PEæ•°é‡ã€æé«˜é¢‘ç‡</td>
                        </tr>
                        <tr>
                            <td>èƒ½æ•ˆ</td>
                            <td>TOPS/W</td>
                            <td>æ•°æ®å¤ç”¨ã€ç”µå‹è°ƒèŠ‚</td>
                            <td>å‡å°‘æ•°æ®ç§»åŠ¨ã€ä½åŠŸè€—è®¾è®¡</td>
                        </tr>
                        <tr>
                            <td>çµæ´»æ€§</td>
                            <td>æ”¯æŒçš„ç®—å­ç±»å‹</td>
                            <td>å¯ç¼–ç¨‹æ€§</td>
                            <td>VLIW/SIMDæ··åˆæ¶æ„</td>
                        </tr>
                        <tr>
                            <td>æˆæœ¬</td>
                            <td>$/TOPS</td>
                            <td>èŠ¯ç‰‡é¢ç§¯</td>
                            <td>æ¶æ„ç®€åŒ–ã€å·¥è‰ºé€‰æ‹©</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>3.2 è®¡ç®—å•å…ƒè®¾è®¡</h3>
            
            <h4>3.2.1 è®¡ç®—é›†ç¾¤æ¶æ„</h4>
            <p>NPUçš„è®¡ç®—èƒ½åŠ›ä¸»è¦æ¥è‡ªäºå¤§è§„æ¨¡å¹¶è¡Œçš„è®¡ç®—é›†ç¾¤ï¼š</p>
            
            <div class="code-block">
// å…¸å‹çš„è®¡ç®—é›†ç¾¤ç»„ç»‡
Compute Cluster
â”œâ”€â”€ MAC Array (è„‰åŠ¨é˜µåˆ—æˆ–å…¶ä»–æ‹“æ‰‘)
â”‚   â”œâ”€â”€ PE[0][0] ... PE[0][N-1]
â”‚   â”œâ”€â”€ PE[1][0] ... PE[1][N-1]
â”‚   â””â”€â”€ PE[M-1][0] ... PE[M-1][N-1]
â”œâ”€â”€ Vector Unit (å‘é‡å¤„ç†å•å…ƒ)
â”‚   â”œâ”€â”€ SIMD ALU
â”‚   â”œâ”€â”€ Special Function Unit
â”‚   â””â”€â”€ Reduction Unit
â”œâ”€â”€ Local Memory
â”‚   â”œâ”€â”€ Weight Buffer
â”‚   â”œâ”€â”€ Input Buffer
â”‚   â””â”€â”€ Output Buffer
â””â”€â”€ Control Unit
    â”œâ”€â”€ Instruction Decoder
    â”œâ”€â”€ Address Generator
    â””â”€â”€ Synchronization Logic
            </div>

            <h4>3.2.2 å¤„ç†å•å…ƒ(PE)è®¾è®¡</h4>
            <div class="info-box">
                <p><strong>PEè®¾è®¡åŸåˆ™ï¼š</strong></p>
                <ul>
                    <li>é¢ç§¯æ•ˆç‡ï¼šæœ€å¤§åŒ–MACå¯†åº¦</li>
                    <li>åŠŸè€—ä¼˜åŒ–ï¼šæ—¶é’Ÿé—¨æ§ã€æ“ä½œæ•°éš”ç¦»</li>
                    <li>æ•°æ®é€šè·¯ï¼šæ”¯æŒå¤šç§ç²¾åº¦(INT8/16, FP16/32)</li>
                    <li>æµæ°´çº¿ï¼šå¹³è¡¡å»¶è¿Ÿå’Œååé‡</li>
                </ul>
            </div>

            <h3>3.3 å­˜å‚¨å±‚æ¬¡ç»“æ„</h3>
            
            <h4>3.3.1 å­˜å‚¨å±‚æ¬¡è®¾è®¡</h4>
            <div class="code-block">
å­˜å‚¨å±‚æ¬¡ï¼ˆä»å¿«åˆ°æ…¢ï¼‰ï¼š
1. Register File (RF)
   - å®¹é‡: ~1KB per PE
   - å»¶è¿Ÿ: 1 cycle
   - å¸¦å®½: æé«˜
   
2. L1 Buffer (ç§æœ‰)
   - å®¹é‡: 16-64KB per cluster
   - å»¶è¿Ÿ: 2-4 cycles
   - ç”¨é€”: æƒé‡/æ¿€æ´»å€¼ç¼“å­˜

3. L2 Buffer (å…±äº«)
   - å®¹é‡: 256KB-2MB
   - å»¶è¿Ÿ: 8-16 cycles
   - ç”¨é€”: è·¨clusteræ•°æ®å…±äº«

4. Global Buffer
   - å®¹é‡: 4-32MB
   - å»¶è¿Ÿ: 20-40 cycles
   - ç”¨é€”: å¤§å‹ç‰¹å¾å›¾å­˜å‚¨

5. External Memory (DDR/HBM)
   - å®¹é‡: GBçº§åˆ«
   - å»¶è¿Ÿ: 100+ cycles
   - å¸¦å®½: å—é™ï¼ˆå…³é”®ç“¶é¢ˆï¼‰
            </div>

            <h4>3.3.2 å†…å­˜è®¿é—®ä¼˜åŒ–</h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>ä¼˜åŒ–æŠ€æœ¯</th>
                            <th>åŸç†</th>
                            <th>ç¡¬ä»¶æ”¯æŒ</th>
                            <th>æ•ˆæœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>æ•°æ®é¢„å–</td>
                            <td>æå‰åŠ è½½æ•°æ®åˆ°ç‰‡ä¸Š</td>
                            <td>ç¡¬ä»¶é¢„å–å™¨</td>
                            <td>éšè—å†…å­˜å»¶è¿Ÿ</td>
                        </tr>
                        <tr>
                            <td>åŒç¼“å†²</td>
                            <td>è®¡ç®—ä¸æ•°æ®ä¼ è¾“é‡å </td>
                            <td>ä¹’ä¹“Buffer</td>
                            <td>æé«˜åˆ©ç”¨ç‡</td>
                        </tr>
                        <tr>
                            <td>æ•°æ®å‹ç¼©</td>
                            <td>å‡å°‘ä¼ è¾“æ•°æ®é‡</td>
                            <td>å‹ç¼©/è§£å‹å•å…ƒ</td>
                            <td>èŠ‚çœå¸¦å®½</td>
                        </tr>
                        <tr>
                            <td>åœ°å€æ˜ å°„</td>
                            <td>ä¼˜åŒ–æ•°æ®å¸ƒå±€</td>
                            <td>å¯ç¼–ç¨‹DMA</td>
                            <td>æé«˜å±€éƒ¨æ€§</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>3.4 äº’è¿ç½‘ç»œè®¾è®¡</h3>
            
            <h4>3.4.1 ç‰‡ä¸Šç½‘ç»œæ‹“æ‰‘</h4>
            <div class="code-block">
å¸¸è§çš„NoCæ‹“æ‰‘ç»“æ„ï¼š

1. Mesh (ç½‘æ ¼)
   ä¼˜ç‚¹ï¼šè§„åˆ™ã€å¯æ‰©å±•
   ç¼ºç‚¹ï¼šè·³æ•°å¤šã€å»¶è¿Ÿå¤§
   
   [R]--[R]--[R]--[R]
    |    |    |    |
   [R]--[R]--[R]--[R]
    |    |    |    |
   [R]--[R]--[R]--[R]

2. Torus (ç¯é¢)
   ä¼˜ç‚¹ï¼šé™ä½å¹³å‡è·³æ•°
   ç¼ºç‚¹ï¼šå¸ƒçº¿å¤æ‚
   
3. Tree (æ ‘å½¢)
   ä¼˜ç‚¹ï¼šå±‚æ¬¡åŒ–ã€æ˜“äºå¹¿æ’­
   ç¼ºç‚¹ï¼šæ ¹èŠ‚ç‚¹ç“¶é¢ˆ

4. Crossbar (äº¤å‰å¼€å…³)
   ä¼˜ç‚¹ï¼šå•è·³è¿æ¥
   ç¼ºç‚¹ï¼šé¢ç§¯O(NÂ²)ï¼Œä¸å¯æ‰©å±•
            </div>

            <h4>3.4.2 æ•°æ®é€šä¿¡æ¨¡å¼</h4>
            <p>NPUä¸­çš„å…¸å‹é€šä¿¡æ¨¡å¼ï¼š</p>
            <ul>
                <li><strong>å•æ’­(Unicast)ï¼š</strong>ç‚¹å¯¹ç‚¹æ•°æ®ä¼ è¾“</li>
                <li><strong>å¤šæ’­(Multicast)ï¼š</strong>æƒé‡å¹¿æ’­åˆ°å¤šä¸ªPE</li>
                <li><strong>å½’çº¦(Reduction)ï¼š</strong>éƒ¨åˆ†å’Œç´¯åŠ </li>
                <li><strong>å…¨å±€åŒæ­¥ï¼š</strong>barrieråŒæ­¥</li>
            </ul>

            <div class="warning-box">
                <p><strong>è®¾è®¡æŒ‘æˆ˜ï¼š</strong>å¦‚ä½•åœ¨ä¿è¯é«˜å¸¦å®½çš„åŒæ—¶æ§åˆ¶åŠŸè€—å’Œé¢ç§¯å¼€é”€æ˜¯NoCè®¾è®¡çš„æ ¸å¿ƒæŒ‘æˆ˜ã€‚</p>
            </div>

            <div class="exercise">
                <h4>ç»ƒä¹ é¢˜é›† 3</h4>
                
                <div class="question">
                    <p><strong>é¢˜ç›®3.1ï¼š</strong>è®¾è®¡ä¸€ä¸ªNPUçš„å­˜å‚¨å±‚æ¬¡ç»“æ„ã€‚ç»™å®šï¼šMACé˜µåˆ—32Ã—32ï¼Œä¸»é¢‘1GHzï¼Œå¤–éƒ¨å†…å­˜å¸¦å®½100GB/sã€‚è®¡ç®—å„çº§å­˜å‚¨çš„å®¹é‡å’Œå¸¦å®½éœ€æ±‚ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šä»MACé˜µåˆ—çš„æ•°æ®éœ€æ±‚å‡ºå‘ï¼Œè€ƒè™‘æ¯ä¸ªMACå•å…ƒæ¯å‘¨æœŸéœ€è¦çš„è¾“å…¥è¾“å‡ºæ•°æ®é‡ï¼Œç„¶åè®¾è®¡å¤šçº§ç¼“å­˜æ¥é€æ­¥é™ä½å¸¦å®½å‹åŠ›ã€‚è®°ä½å¸¦å®½éœ€æ±‚åº”è¯¥é€çº§é€’å‡ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <p><strong>1. è®¡ç®—MACé˜µåˆ—å¸¦å®½éœ€æ±‚ï¼š</strong></p>
                        <ul>
                            <li>MACé˜µåˆ—è§„æ¨¡ï¼š32Ã—32 = 1024ä¸ªMAC</li>
                            <li>æ¯ä¸ªMACæ¯å‘¨æœŸéœ€è¦ï¼š2ä¸ªè¾“å…¥(weight, activation) + 1ä¸ªè¾“å‡º</li>
                            <li>å‡è®¾INT8ç²¾åº¦ï¼šæ¯ä¸ªæ•°æ®1å­—èŠ‚</li>
                            <li>æ€»å¸¦å®½éœ€æ±‚ï¼š1024 Ã— 3 Ã— 1B Ã— 1GHz = 3.072 TB/s</li>
                        </ul>
                        
                        <p><strong>2. å­˜å‚¨å±‚æ¬¡è®¾è®¡ï¼š</strong></p>
                        <table>
                            <tr>
                                <th>å­˜å‚¨çº§åˆ«</th>
                                <th>å®¹é‡</th>
                                <th>å¸¦å®½</th>
                                <th>è®¾è®¡ç†ç”±</th>
                            </tr>
                            <tr>
                                <td>L0 (Register)</td>
                                <td>1KB/PE</td>
                                <td>3TB/s</td>
                                <td>ç›´æ¥ä¾›ç»™MACè¿ç®—</td>
                            </tr>
                            <tr>
                                <td>L1 Buffer</td>
                                <td>64KB</td>
                                <td>1TB/s</td>
                                <td>å­˜å‚¨å½“å‰tileçš„æ•°æ®</td>
                            </tr>
                            <tr>
                                <td>L2 Buffer</td>
                                <td>2MB</td>
                                <td>400GB/s</td>
                                <td>é¢„å–ä¸‹ä¸€ä¸ªtile</td>
                            </tr>
                            <tr>
                                <td>Global Buffer</td>
                                <td>16MB</td>
                                <td>200GB/s</td>
                                <td>å­˜å‚¨æ•´å±‚çš„éƒ¨åˆ†æ•°æ®</td>
                            </tr>
                            <tr>
                                <td>External Mem</td>
                                <td>16GB</td>
                                <td>100GB/s</td>
                                <td>ç»™å®šçº¦æŸ</td>
                            </tr>
                        </table>
                        
                        <p><strong>3. å¸¦å®½é€çº§é€’å‡åŸç†ï¼š</strong></p>
                        <ul>
                            <li>æ•°æ®å¤ç”¨é™ä½ä¸Šçº§éœ€æ±‚</li>
                            <li>æ—¶åˆ†å¤ç”¨å…±äº«å¸¦å®½</li>
                            <li>é¢„å–éšè—å»¶è¿Ÿ</li>
                        </ul>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®3.2ï¼š</strong>æ¯”è¾ƒWeight Stationaryã€Output Stationaryå’ŒRow Stationaryä¸‰ç§æ•°æ®æµçš„ä¼˜ç¼ºç‚¹ï¼Œå¹¶ç»™å‡ºé€‚ç”¨åœºæ™¯ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šæ¯ç§æ•°æ®æµçš„æ ¸å¿ƒåŒºåˆ«åœ¨äºå“ªç§æ•°æ®è¢«å›ºå®šåœ¨PEä¸­ã€‚åˆ†æä¸åŒç¥ç»ç½‘ç»œå±‚ï¼ˆå…¨è¿æ¥å±‚ã€1Ã—1å·ç§¯ã€3Ã—3å·ç§¯ï¼‰çš„æ•°æ®å¤ç”¨ç‰¹æ€§ï¼Œæ¥åˆ¤æ–­æœ€é€‚åˆçš„æ•°æ®æµã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <table>
                            <tr>
                                <th>æ•°æ®æµ</th>
                                <th>å›ºå®šæ•°æ®</th>
                                <th>ä¼˜ç‚¹</th>
                                <th>ç¼ºç‚¹</th>
                                <th>é€‚ç”¨åœºæ™¯</th>
                            </tr>
                            <tr>
                                <td>Weight Stationary (WS)</td>
                                <td>æƒé‡</td>
                                <td>â€¢ æƒé‡å¤ç”¨æœ€å¤§åŒ–<br>â€¢ å‡å°‘æƒé‡è¯»å–èƒ½è€—<br>â€¢ å®ç°ç®€å•</td>
                                <td>â€¢ è¾“å…¥/è¾“å‡ºéœ€è¦å¤§é‡ç§»åŠ¨<br>â€¢ å¯¹å¤§feature mapä¸å‹å¥½</td>
                                <td>â€¢ å…¨è¿æ¥å±‚<br>â€¢ å°batchæ¨ç†<br>â€¢ æƒé‡>>æ¿€æ´»å€¼</td>
                            </tr>
                            <tr>
                                <td>Output Stationary (OS)</td>
                                <td>éƒ¨åˆ†å’Œ</td>
                                <td>â€¢ å‡å°‘éƒ¨åˆ†å’Œè¯»å†™<br>â€¢ ç´¯åŠ åœ¨PEæœ¬åœ°å®Œæˆ<br>â€¢ é€‚åˆæ·±åº¦ç½‘ç»œ</td>
                                <td>â€¢ æƒé‡å’Œè¾“å…¥éƒ½éœ€ç§»åŠ¨<br>â€¢ æ§åˆ¶å¤æ‚åº¦é«˜</td>
                                <td>â€¢ æ·±åº¦å·ç§¯<br>â€¢ è¾“å‡ºé€šé“æ•°å¤š<br>â€¢ ResNetç±»ç»“æ„</td>
                            </tr>
                            <tr>
                                <td>Row Stationary (RS)</td>
                                <td>å·ç§¯è¡Œ</td>
                                <td>â€¢ æ‰€æœ‰æ•°æ®ç±»å‹éƒ½æœ‰å¤ç”¨<br>â€¢ èƒ½é‡æ•ˆç‡æœ€ä¼˜<br>â€¢ é€‚åº”æ€§å¼º</td>
                                <td>â€¢ å®ç°æœ€å¤æ‚<br>â€¢ éœ€è¦å¤æ‚çš„æ§åˆ¶å™¨<br>â€¢ é¢ç§¯å¼€é”€å¤§</td>
                                <td>â€¢ é€šç”¨åœºæ™¯<br>â€¢ å„ç§å·ç§¯å±‚<br>â€¢ éœ€è¦çµæ´»æ€§</td>
                            </tr>
                        </table>
                        
                        <p><strong>å…·ä½“ä¾‹å­ï¼š</strong></p>
                        <p>å¯¹äº1Ã—1å·ç§¯ï¼ˆPointwiseï¼‰ï¼š</p>
                        <ul>
                            <li>WSæœ€ä¼˜ï¼šå› ä¸ºæ²¡æœ‰ç©ºé—´ç»´åº¦çš„å¤ç”¨</li>
                            <li>RSé€€åŒ–ä¸ºWS</li>
                        </ul>
                        <p>å¯¹äº3Ã—3å·ç§¯ï¼š</p>
                        <ul>
                            <li>RSæœ€ä¼˜ï¼šå¯ä»¥å¤ç”¨æ‰€æœ‰ç»´åº¦çš„æ•°æ®</li>
                            <li>OSæ¬¡ä¼˜ï¼šå¦‚æœè¾“å‡ºé€šé“å¾ˆå¤š</li>
                        </ul>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®3.3ï¼š</strong>è®¾è®¡ä¸€ä¸ª4Ã—4 Mesh NoCçš„è·¯ç”±å™¨ã€‚è¦æ±‚æ”¯æŒXYè·¯ç”±ç®—æ³•ï¼ŒåŒ…å«5ä¸ªç«¯å£ï¼ˆä¸œå—è¥¿åŒ—+æœ¬åœ°ï¼‰ã€‚ç»™å‡ºRTLæ¡†æ¶ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šè·¯ç”±å™¨éœ€è¦åŒ…å«è¾“å…¥ç¼“å†²ï¼ˆFIFOï¼‰ã€è·¯ç”±è®¡ç®—ï¼ˆXYç®—æ³•å…ˆXåYï¼‰ã€ä»²è£å™¨ï¼ˆå¤„ç†å†²çªï¼‰ã€äº¤å‰å¼€å…³ï¼ˆ5Ã—5è¿æ¥çŸ©é˜µï¼‰ã€‚æ³¨æ„å¤„ç†èƒŒå‹å’Œæµæ§ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <div class="code-block">
module MeshRouter #(
    parameter DATA_WIDTH = 32,
    parameter ADDR_WIDTH = 8,
    parameter X_COORD = 0,
    parameter Y_COORD = 0,
    parameter FIFO_DEPTH = 4
)(
    input wire clk,
    input wire rst_n,
    
    // 5ä¸ªè¾“å…¥ç«¯å£ (North, South, East, West, Local)
    input wire [DATA_WIDTH-1:0] data_in_n, data_in_s, data_in_e, data_in_w, data_in_l,
    input wire valid_in_n, valid_in_s, valid_in_e, valid_in_w, valid_in_l,
    output wire ready_out_n, ready_out_s, ready_out_e, ready_out_w, ready_out_l,
    
    // 5ä¸ªè¾“å‡ºç«¯å£
    output wire [DATA_WIDTH-1:0] data_out_n, data_out_s, data_out_e, data_out_w, data_out_l,
    output wire valid_out_n, valid_out_s, valid_out_e, valid_out_w, valid_out_l,
    input wire ready_in_n, ready_in_s, ready_in_e, ready_in_w, ready_in_l
);

    // æ•°æ®åŒ…æ ¼å¼ï¼š[DATA | SRC_Y | SRC_X | DST_Y | DST_X]
    localparam DST_X_START = 0;
    localparam DST_X_END = 3;
    localparam DST_Y_START = 4;
    localparam DST_Y_END = 7;
    
    // å†…éƒ¨ä¿¡å·
    wire [4:0] route_req_n, route_req_s, route_req_e, route_req_w, route_req_l;
    wire [4:0] grant_n, grant_s, grant_e, grant_w, grant_l;
    
    // è¾“å…¥FIFO
    wire [DATA_WIDTH-1:0] fifo_data_n, fifo_data_s, fifo_data_e, fifo_data_w, fifo_data_l;
    wire fifo_empty_n, fifo_empty_s, fifo_empty_e, fifo_empty_w, fifo_empty_l;
    wire fifo_rd_en_n, fifo_rd_en_s, fifo_rd_en_e, fifo_rd_en_w, fifo_rd_en_l;
    
    // FIFOå®ä¾‹åŒ–ï¼ˆæ¯ä¸ªè¾“å…¥ç«¯å£ä¸€ä¸ªï¼‰
    genvar i;
    generate
        // North port FIFO
        FIFO #(.WIDTH(DATA_WIDTH), .DEPTH(FIFO_DEPTH)) fifo_n (
            .clk(clk), .rst_n(rst_n),
            .wr_en(valid_in_n), .wr_data(data_in_n),
            .rd_en(fifo_rd_en_n), .rd_data(fifo_data_n),
            .empty(fifo_empty_n), .full(~ready_out_n)
        );
        // ç±»ä¼¼åœ°å®ä¾‹åŒ–å…¶ä»–4ä¸ªFIFO...
    endgenerate
    
    // XYè·¯ç”±è®¡ç®—æ¨¡å—
    XYRouteCompute route_comp_n (
        .current_x(X_COORD), .current_y(Y_COORD),
        .dest_x(fifo_data_n[DST_X_END:DST_X_START]),
        .dest_y(fifo_data_n[DST_Y_END:DST_Y_START]),
        .valid(!fifo_empty_n),
        .route_request(route_req_n)  // 5-bit one-hot
    );
    // ä¸ºå…¶ä»–ç«¯å£å®ä¾‹åŒ–è·¯ç”±è®¡ç®—...
    
    // 5Ã—5äº¤å‰å¼€å…³ä»²è£å™¨
    SwitchAllocator allocator (
        .clk(clk), .rst_n(rst_n),
        // æ¥è‡ª5ä¸ªè¾“å…¥ç«¯å£çš„è¯·æ±‚
        .req_n(route_req_n), .req_s(route_req_s), 
        .req_e(route_req_e), .req_w(route_req_w), .req_l(route_req_l),
        // æˆæƒä¿¡å·
        .grant_n(grant_n), .grant_s(grant_s),
        .grant_e(grant_e), .grant_w(grant_w), .grant_l(grant_l)
    );
    
    // äº¤å‰å¼€å…³çŸ©é˜µ
    Crossbar5x5 xbar (
        // è¾“å…¥æ•°æ®
        .data_in({fifo_data_l, fifo_data_w, fifo_data_e, fifo_data_s, fifo_data_n}),
        // æ§åˆ¶ä¿¡å·
        .sel_n(grant_n), .sel_s(grant_s), 
        .sel_e(grant_e), .sel_w(grant_w), .sel_l(grant_l),
        // è¾“å‡ºæ•°æ®
        .data_out_n(data_out_n), .data_out_s(data_out_s),
        .data_out_e(data_out_e), .data_out_w(data_out_w), .data_out_l(data_out_l)
    );
    
    // è¾“å‡ºvalidä¿¡å·ç”Ÿæˆ
    assign valid_out_n = |grant_n & ready_in_n;
    assign valid_out_s = |grant_s & ready_in_s;
    assign valid_out_e = |grant_e & ready_in_e;
    assign valid_out_w = |grant_w & ready_in_w;
    assign valid_out_l = |grant_l & ready_in_l;
    
    // FIFOè¯»ä½¿èƒ½
    assign fifo_rd_en_n = |(grant_n & {ready_in_l, ready_in_w, ready_in_e, ready_in_s, ready_in_n});
    // ç±»ä¼¼å¤„ç†å…¶ä»–ç«¯å£...

endmodule

// XYè·¯ç”±è®¡ç®—æ¨¡å—
module XYRouteCompute #(
    parameter COORD_WIDTH = 4
)(
    input [COORD_WIDTH-1:0] current_x, current_y,
    input [COORD_WIDTH-1:0] dest_x, dest_y,
    input valid,
    output reg [4:0] route_request  // [Local, West, East, South, North]
);
    always @(*) begin
        route_request = 5'b00000;
        if (valid) begin
            if (dest_x == current_x && dest_y == current_y) begin
                route_request[4] = 1'b1;  // Local
            end else if (dest_x < current_x) begin
                route_request[3] = 1'b1;  // West
            end else if (dest_x > current_x) begin
                route_request[2] = 1'b1;  // East
            end else if (dest_y < current_y) begin
                route_request[1] = 1'b1;  // South
            end else begin
                route_request[0] = 1'b1;  // North
            end
        end
    end
endmodule
                        </div>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®3.4ï¼š</strong>è®¡ç®—ä¸€ä¸ªNPUæ‰§è¡ŒResNet50ä¸€ä¸ªæ®‹å·®å—æ‰€éœ€çš„ç‰‡ä¸Šå­˜å‚¨å®¹é‡ã€‚å‡è®¾ç‰¹å¾å›¾å¤§å°ä¸º56Ã—56Ã—256ï¼Œä½¿ç”¨3Ã—3å·ç§¯ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šResNetæ®‹å·®å—åŒ…å«å¤šä¸ªå·ç§¯å±‚å’Œshortcutè¿æ¥ã€‚è®¡ç®—æ¯å±‚çš„è¾“å…¥ã€è¾“å‡ºã€æƒé‡å¤§å°ï¼Œè€ƒè™‘æµæ°´çº¿æ‰§è¡Œæ—¶çš„æ•°æ®é‡å ï¼Œä»¥åŠåŒç¼“å†²éœ€æ±‚ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <p><strong>ResNet50æ®‹å·®å—ç»“æ„ï¼š</strong></p>
                        <pre>
Input (56Ã—56Ã—256)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚
    â–¼                     â”‚
Conv1 (1Ã—1, 64)          â”‚
    â”‚                     â”‚
    â–¼                     â”‚
Conv2 (3Ã—3, 64)          â”‚
    â”‚                     â”‚
    â–¼                     â”‚
Conv3 (1Ã—1, 256)         â”‚
    â”‚                     â”‚
    â–¼                     â”‚
    + â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
Output (56Ã—56Ã—256)
                        </pre>
                        
                        <p><strong>å­˜å‚¨éœ€æ±‚è®¡ç®—ï¼ˆINT8ï¼‰ï¼š</strong></p>
                        <table>
                            <tr>
                                <th>æ•°æ®ç±»å‹</th>
                                <th>å°ºå¯¸</th>
                                <th>å®¹é‡(KB)</th>
                                <th>è¯´æ˜</th>
                            </tr>
                            <tr>
                                <td>è¾“å…¥ç‰¹å¾å›¾</td>
                                <td>56Ã—56Ã—256</td>
                                <td>784</td>
                                <td>éœ€è¦ä¿å­˜ç”¨äºæ®‹å·®è¿æ¥</td>
                            </tr>
                            <tr>
                                <td>Conv1æƒé‡</td>
                                <td>1Ã—1Ã—256Ã—64</td>
                                <td>16</td>
                                <td>Pointwiseå·ç§¯</td>
                            </tr>
                            <tr>
                                <td>Conv1è¾“å‡º</td>
                                <td>56Ã—56Ã—64</td>
                                <td>196</td>
                                <td>ä¸­é—´ç‰¹å¾å›¾</td>
                            </tr>
                            <tr>
                                <td>Conv2æƒé‡</td>
                                <td>3Ã—3Ã—64Ã—64</td>
                                <td>36</td>
                                <td>Depthwiseå·ç§¯</td>
                            </tr>
                            <tr>
                                <td>Conv2è¾“å‡º</td>
                                <td>56Ã—56Ã—64</td>
                                <td>196</td>
                                <td>ä¸­é—´ç‰¹å¾å›¾</td>
                            </tr>
                            <tr>
                                <td>Conv3æƒé‡</td>
                                <td>1Ã—1Ã—64Ã—256</td>
                                <td>16</td>
                                <td>Pointwiseå·ç§¯</td>
                            </tr>
                            <tr>
                                <td>Conv3è¾“å‡º</td>
                                <td>56Ã—56Ã—256</td>
                                <td>784</td>
                                <td>ç”¨äºæ®‹å·®åŠ æ³•</td>
                            </tr>
                            <tr>
                                <td><strong>æ€»è®¡</strong></td>
                                <td>-</td>
                                <td><strong>2028</strong></td>
                                <td>çº¦2MB</td>
                            </tr>
                        </table>
                        
                        <p><strong>ä¼˜åŒ–ç­–ç•¥ï¼š</strong></p>
                        <ol>
                            <li><strong>å±‚èåˆï¼š</strong>å°†Conv1è¾“å‡ºç›´æ¥é€å…¥Conv2ï¼ŒèŠ‚çœ196KB</li>
                            <li><strong>æµæ°´çº¿æ‰§è¡Œï¼š</strong>åˆ†å—å¤„ç†ï¼Œæ¯å—åªéœ€å­˜å‚¨éƒ¨åˆ†ç‰¹å¾å›¾</li>
                            <li><strong>æƒé‡å‹ç¼©ï¼š</strong>ä½¿ç”¨ç¨€ç–æˆ–é‡åŒ–æŠ€æœ¯å‡å°‘æƒé‡å­˜å‚¨</li>
                            <li><strong>åŒç¼“å†²ï¼š</strong>è®¡ç®—å½“å‰å—æ—¶é¢„å–ä¸‹ä¸€å—æ•°æ®</li>
                        </ol>
                        
                        <p><strong>å®é™…éœ€æ±‚ï¼š</strong>è€ƒè™‘ä¼˜åŒ–åï¼Œç‰‡ä¸Šå­˜å‚¨çº¦éœ€1MBå³å¯é«˜æ•ˆæ‰§è¡Œã€‚</p>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®3.5ï¼š</strong>è®¾è®¡ä¸€ä¸ªDMAæ§åˆ¶å™¨ï¼Œæ”¯æŒ2Dæ•°æ®ä¼ è¾“å’Œç®€å•çš„æ•°æ®é‡æ’ã€‚è¦æ±‚æ”¯æŒstrideè®¿é—®æ¨¡å¼ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šDMAéœ€è¦æ”¯æŒ2Dæ•°æ®ä¼ è¾“ï¼ˆå®½åº¦Ã—é«˜åº¦ï¼‰ï¼ŒåŒ…æ‹¬æºå’Œç›®æ ‡çš„strideè·¨æ­¥ã€‚è€ƒè™‘ä¸åŒä¼ è¾“æ¨¡å¼ï¼šçº¿æ€§ã€2Då—ã€è½¬ç½®ã€äº¤ç»‡ç­‰ã€‚ä½¿ç”¨çŠ¶æ€æœºç®¡ç†ä¼ è¾“æµç¨‹ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <div class="code-block">
module DMA2D #(
    parameter ADDR_WIDTH = 32,
    parameter DATA_WIDTH = 128,  // 128-bitå®½æ¥å£
    parameter BURST_LEN = 16     // æœ€å¤§çªå‘é•¿åº¦
)(
    input wire clk,
    input wire rst_n,
    
    // é…ç½®æ¥å£
    input wire [ADDR_WIDTH-1:0] src_addr,      // æºåœ°å€
    input wire [ADDR_WIDTH-1:0] dst_addr,      // ç›®æ ‡åœ°å€
    input wire [15:0] width,                   // 2Dä¼ è¾“å®½åº¦ï¼ˆå­—èŠ‚ï¼‰
    input wire [15:0] height,                  // 2Dä¼ è¾“é«˜åº¦
    input wire [15:0] src_stride,              // æºè·¨æ­¥ï¼ˆå­—èŠ‚ï¼‰
    input wire [15:0] dst_stride,              // ç›®æ ‡è·¨æ­¥ï¼ˆå­—èŠ‚ï¼‰
    input wire [2:0] transfer_mode,            // ä¼ è¾“æ¨¡å¼
    input wire start,
    output reg done,
    output reg busy,
    
    // æºå†…å­˜æ¥å£ï¼ˆAXI-likeï¼‰
    output reg [ADDR_WIDTH-1:0] src_araddr,
    output reg src_arvalid,
    input wire src_arready,
    input wire [DATA_WIDTH-1:0] src_rdata,
    input wire src_rvalid,
    output reg src_rready,
    
    // ç›®æ ‡å†…å­˜æ¥å£
    output reg [ADDR_WIDTH-1:0] dst_awaddr,
    output reg dst_awvalid,
    input wire dst_awready,
    output reg [DATA_WIDTH-1:0] dst_wdata,
    output reg dst_wvalid,
    input wire dst_wready,
    input wire dst_bvalid,
    output reg dst_bready
);

    // ä¼ è¾“æ¨¡å¼å®šä¹‰
    localparam MODE_LINEAR = 3'd0;      // çº¿æ€§ä¼ è¾“
    localparam MODE_2D_BLOCK = 3'd1;    // 2Då—ä¼ è¾“
    localparam MODE_TRANSPOSE = 3'd2;   // è½¬ç½®
    localparam MODE_INTERLEAVE = 3'd3;  // äº¤ç»‡
    
    // çŠ¶æ€æœº
    localparam IDLE = 3'd0;
    localparam CALC_ADDR = 3'd1;
    localparam READ_REQ = 3'd2;
    localparam READ_DATA = 3'd3;
    localparam WRITE_REQ = 3'd4;
    localparam WRITE_DATA = 3'd5;
    localparam WRITE_RESP = 3'd6;
    localparam NEXT_LINE = 3'd7;
    
    reg [2:0] state, next_state;
    
    // å†…éƒ¨è®¡æ•°å™¨
    reg [15:0] row_cnt, col_cnt;
    reg [15:0] burst_cnt;
    reg [ADDR_WIDTH-1:0] current_src_addr, current_dst_addr;
    
    // æ•°æ®ç¼“å†²ï¼ˆæ”¯æŒçªå‘ä¼ è¾“ï¼‰
    reg [DATA_WIDTH-1:0] data_buffer [0:BURST_LEN-1];
    reg [4:0] buffer_wr_ptr, buffer_rd_ptr;
    reg [4:0] buffer_count;
    
    // åœ°å€è®¡ç®—å•å…ƒ
    always @(posedge clk or negedge rst_n) begin
        if (!rst_n) begin
            current_src_addr <= 0;
            current_dst_addr <= 0;
        end else if (state == CALC_ADDR) begin
            case (transfer_mode)
                MODE_LINEAR: begin
                    current_src_addr <= src_addr + (row_cnt * src_stride) + col_cnt;
                    current_dst_addr <= dst_addr + (row_cnt * dst_stride) + col_cnt;
                end
                MODE_2D_BLOCK: begin
                    current_src_addr <= src_addr + (row_cnt * src_stride) + col_cnt;
                    current_dst_addr <= dst_addr + (row_cnt * dst_stride) + col_cnt;
                end
                MODE_TRANSPOSE: begin
                    // è½¬ç½®ï¼šæºæŒ‰è¡Œè¯»ï¼Œç›®æ ‡æŒ‰åˆ—å†™
                    current_src_addr <= src_addr + (row_cnt * src_stride) + col_cnt;
                    current_dst_addr <= dst_addr + (col_cnt * dst_stride) + row_cnt * (DATA_WIDTH/8);
                end
                MODE_INTERLEAVE: begin
                    // äº¤ç»‡æ¨¡å¼ï¼šç”¨äºé€šé“é‡æ’
                    // å®ç°NCHW -> NHWCè½¬æ¢ç­‰
                    current_src_addr <= src_addr + calculate_interleave_src(row_cnt, col_cnt);
                    current_dst_addr <= dst_addr + calculate_interleave_dst(row_cnt, col_cnt);
                end
            endcase
        end
    end
    
    // çŠ¶æ€æœºæ§åˆ¶
    always @(posedge clk or negedge rst_n) begin
        if (!rst_n)
            state <= IDLE;
        else
            state <= next_state;
    end
    
    always @(*) begin
        next_state = state;
        case (state)
            IDLE: begin
                if (start)
                    next_state = CALC_ADDR;
            end
            
            CALC_ADDR: begin
                next_state = READ_REQ;
            end
            
            READ_REQ: begin
                if (src_arready)
                    next_state = READ_DATA;
            end
            
            READ_DATA: begin
                if (src_rvalid && burst_cnt == calculate_burst_len() - 1)
                    next_state = WRITE_REQ;
            end
            
            WRITE_REQ: begin
                if (dst_awready)
                    next_state = WRITE_DATA;
            end
            
            WRITE_DATA: begin
                if (dst_wready && buffer_rd_ptr == buffer_wr_ptr - 1)
                    next_state = WRITE_RESP;
            end
            
            WRITE_RESP: begin
                if (dst_bvalid)
                    next_state = NEXT_LINE;
            end
            
            NEXT_LINE: begin
                if (row_cnt == height - 1 && col_cnt >= width - (DATA_WIDTH/8))
                    next_state = IDLE;
                else
                    next_state = CALC_ADDR;
            end
        endcase
    end
    
    // æ•°æ®è·¯å¾„æ§åˆ¶
    always @(posedge clk or negedge rst_n) begin
        if (!rst_n) begin
            row_cnt <= 0;
            col_cnt <= 0;
            burst_cnt <= 0;
            buffer_wr_ptr <= 0;
            buffer_rd_ptr <= 0;
            done <= 0;
            busy <= 0;
        end else begin
            case (state)
                IDLE: begin
                    done <= 0;
                    if (start) begin
                        row_cnt <= 0;
                        col_cnt <= 0;
                        busy <= 1;
                    end
                end
                
                READ_DATA: begin
                    if (src_rvalid) begin
                        data_buffer[buffer_wr_ptr] <= apply_transform(src_rdata);
                        buffer_wr_ptr <= buffer_wr_ptr + 1;
                        burst_cnt <= burst_cnt + 1;
                    end
                end
                
                WRITE_DATA: begin
                    if (dst_wready) begin
                        buffer_rd_ptr <= buffer_rd_ptr + 1;
                    end
                end
                
                NEXT_LINE: begin
                    col_cnt <= col_cnt + (DATA_WIDTH/8) * calculate_burst_len();
                    if (col_cnt >= width - (DATA_WIDTH/8)) begin
                        col_cnt <= 0;
                        row_cnt <= row_cnt + 1;
                        if (row_cnt == height - 1) begin
                            done <= 1;
                            busy <= 0;
                        end
                    end
                    burst_cnt <= 0;
                    buffer_wr_ptr <= 0;
                    buffer_rd_ptr <= 0;
                end
            endcase
        end
    end
    
    // AXIæ¥å£ä¿¡å·
    always @(*) begin
        // é»˜è®¤å€¼
        src_arvalid = 0;
        src_rready = 0;
        dst_awvalid = 0;
        dst_wvalid = 0;
        dst_bready = 0;
        
        case (state)
            READ_REQ: begin
                src_araddr = current_src_addr;
                src_arvalid = 1;
            end
            
            READ_DATA: begin
                src_rready = 1;
            end
            
            WRITE_REQ: begin
                dst_awaddr = current_dst_addr;
                dst_awvalid = 1;
            end
            
            WRITE_DATA: begin
                dst_wdata = data_buffer[buffer_rd_ptr];
                dst_wvalid = 1;
            end
            
            WRITE_RESP: begin
                dst_bready = 1;
            end
        endcase
    end
    
    // è¾…åŠ©å‡½æ•°
    function [4:0] calculate_burst_len;
        begin
            // æ ¹æ®å‰©ä½™æ•°æ®é‡è®¡ç®—çªå‘é•¿åº¦
            if (width - col_cnt >= BURST_LEN * (DATA_WIDTH/8))
                calculate_burst_len = BURST_LEN;
            else
                calculate_burst_len = (width - col_cnt) / (DATA_WIDTH/8);
        end
    endfunction
    
    function [DATA_WIDTH-1:0] apply_transform;
        input [DATA_WIDTH-1:0] data;
        begin
            // æ ¹æ®æ¨¡å¼åº”ç”¨æ•°æ®å˜æ¢ï¼ˆå¦‚å­—èŠ‚åºè½¬æ¢ç­‰ï¼‰
            case (transfer_mode)
                MODE_LINEAR, MODE_2D_BLOCK: 
                    apply_transform = data;
                MODE_TRANSPOSE:
                    apply_transform = transpose_bytes(data);
                MODE_INTERLEAVE:
                    apply_transform = interleave_channels(data);
                default:
                    apply_transform = data;
            endcase
        end
    endfunction

endmodule
                        </div>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®3.6ï¼š</strong>åˆ†æTensor Coreæ¶æ„ç›¸æ¯”ä¼ ç»ŸMACé˜µåˆ—çš„ä¼˜åŠ¿ï¼Œå¹¶è®¡ç®—å…¶ç†è®ºæ€§èƒ½æå‡ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šTensor Coreæ˜¯ä»¥çŸ©é˜µä¸ºåŸºæœ¬è®¡ç®—å•ä½ï¼Œè€Œä¸æ˜¯æ ‡é‡ã€‚æ¯”è¾ƒä¸€æ¬¡æ“ä½œå®Œæˆçš„è®¡ç®—é‡ã€æ•°æ®å¤ç”¨ç‡ã€å¸¦å®½éœ€æ±‚ã€‚è€ƒè™‘ä¸åŒç²¾åº¦ï¼ˆFP16ã€INT8ï¼‰çš„å½±å“ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <p><strong>1. æ¶æ„å¯¹æ¯”ï¼š</strong></p>
                        <table>
                            <tr>
                                <th>ç‰¹æ€§</th>
                                <th>ä¼ ç»ŸMACé˜µåˆ—</th>
                                <th>Tensor Core</th>
                            </tr>
                            <tr>
                                <td>åŸºæœ¬è¿ç®—</td>
                                <td>æ ‡é‡MAC: c += a Ã— b</td>
                                <td>çŸ©é˜µMAC: D = AÃ—B + C</td>
                            </tr>
                            <tr>
                                <td>è¿ç®—ç²’åº¦</td>
                                <td>1Ã—1</td>
                                <td>4Ã—4Ã—4 (æˆ–æ›´å¤§)</td>
                            </tr>
                            <tr>
                                <td>æ¯å‘¨æœŸè¿ç®—é‡</td>
                                <td>2 ops (ä¹˜+åŠ )</td>
                                <td>128 ops (4Ã—4Ã—4Ã—2)</td>
                            </tr>
                            <tr>
                                <td>æ•°æ®å¤ç”¨</td>
                                <td>æœ‰é™</td>
                                <td>çŸ©é˜µçº§å¤ç”¨</td>
                            </tr>
                        </table>
                        
                        <p><strong>2. Tensor Coreå·¥ä½œåŸç†ï¼š</strong></p>
                        <div class="code-block">
// Tensor Coreæ‰§è¡Œçš„è¿ç®—
D[4Ã—4] = A[4Ã—4] Ã— B[4Ã—4] + C[4Ã—4]

// åˆ†è§£ä¸ºæ ‡é‡è¿ç®—ï¼š
for i in 0..3:
    for j in 0..3:
        sum = 0
        for k in 0..3:
            sum += A[i][k] * B[k][j]
        D[i][j] = sum + C[i][j]

// æ€»è¿ç®—æ•°ï¼š4Ã—4Ã—4 = 64æ¬¡ä¹˜æ³•ï¼Œ48æ¬¡åŠ æ³•ï¼Œ16æ¬¡åŠ æ³•
// å…±128 ops
                        </div>
                        
                        <p><strong>3. æ€§èƒ½æå‡è®¡ç®—ï¼š</strong></p>
                        <p>å‡è®¾ï¼š</p>
                        <ul>
                            <li>ä¼ ç»ŸMACé˜µåˆ—ï¼š16Ã—16 = 256ä¸ªMACå•å…ƒ</li>
                            <li>Tensor Coreé˜µåˆ—ï¼š4Ã—4 = 16ä¸ªTensor Core</li>
                            <li>ç›¸åŒçš„æ€»ç¡¬ä»¶é¢ç§¯</li>
                        </ul>
                        
                        <p>æ€§èƒ½å¯¹æ¯”ï¼š</p>
                        <ul>
                            <li>ä¼ ç»ŸMACï¼š256 Ã— 2 = 512 ops/cycle</li>
                            <li>Tensor Coreï¼š16 Ã— 128 = 2048 ops/cycle</li>
                            <li><strong>ç†è®ºåŠ é€Ÿæ¯”ï¼š4Ã—</strong></li>
                        </ul>
                        
                        <p><strong>4. ä¼˜åŠ¿åˆ†æï¼š</strong></p>
                        <ol>
                            <li><strong>æ›´é«˜çš„è®¡ç®—å¯†åº¦ï¼š</strong>ç›¸åŒé¢ç§¯ä¸‹æä¾›æ›´å¤šè¿ç®—</li>
                            <li><strong>æ›´å¥½çš„æ•°æ®å¤ç”¨ï¼š</strong>çŸ©é˜µè¿ç®—å¤©ç„¶å…·æœ‰æ•°æ®å¤ç”¨</li>
                            <li><strong>å‡å°‘æ§åˆ¶å¼€é”€ï¼š</strong>ä¸€æ¡æŒ‡ä»¤å®Œæˆæ›´å¤šè¿ç®—</li>
                            <li><strong>æ›´é€‚åˆæ·±åº¦å­¦ä¹ ï¼š</strong>ç›´æ¥åŒ¹é…GEMMè¿ç®—æ¨¡å¼</li>
                        </ol>
                        
                        <p><strong>5. é™åˆ¶æ¡ä»¶ï¼š</strong></p>
                        <ul>
                            <li>éœ€è¦å¯¹é½åˆ°4Ã—4å—å¤§å°</li>
                            <li>ä¸é€‚åˆç¨€ç–æˆ–ä¸è§„åˆ™è¿ç®—</li>
                            <li>ç²¾åº¦é™åˆ¶ï¼ˆé€šå¸¸æ˜¯æ··åˆç²¾åº¦ï¼‰</li>
                            <li>ç¼–ç¨‹æ¨¡å‹ç›¸å¯¹å¤æ‚</li>
                        </ul>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®3.7ï¼š</strong>è®¾è®¡ä¸€ä¸ªç®€å•çš„NPUæŒ‡ä»¤é›†æ¶æ„(ISA)ï¼ŒåŒ…å«è®¡ç®—ã€æ•°æ®ä¼ è¾“å’Œæ§åˆ¶æŒ‡ä»¤ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šNPU ISAéœ€è¦æ”¯æŒçŸ©é˜µè¿ç®—ã€å·ç§¯ã€æ¿€æ´»å‡½æ•°ç­‰ã€‚è®¾è®¡æŒ‡ä»¤æ ¼å¼ã€å¯»å€æ¨¡å¼ã€å¯„å­˜å™¨æ–‡ä»¶ã€‚è€ƒè™‘VLIWæˆ–SIMDæŒ‡ä»¤é›†çš„ç‰¹ç‚¹ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <p><strong>NPU ISAè®¾è®¡ï¼š</strong></p>
                        
                        <p><strong>1. æŒ‡ä»¤æ ¼å¼ï¼ˆ32-bitï¼‰ï¼š</strong></p>
                        <div class="code-block">
[31:28] | [27:24] | [23:16] | [15:8] | [7:0]
OPCODE  | FLAGS   | DEST    | SRC1   | SRC2/IMM

OPCODE: 4-bit æ“ä½œç 
FLAGS:  4-bit æ ‡å¿—ä½ï¼ˆç²¾åº¦ã€é¥±å’Œæ¨¡å¼ç­‰ï¼‰
DEST:   8-bit ç›®æ ‡å¯„å­˜å™¨/åœ°å€
SRC1:   8-bit æºæ“ä½œæ•°1
SRC2:   8-bit æºæ“ä½œæ•°2æˆ–ç«‹å³æ•°
                        </div>
                        
                        <p><strong>2. æŒ‡ä»¤é›†åˆ†ç±»ï¼š</strong></p>
                        
                        <p><strong>A. è®¡ç®—æŒ‡ä»¤ï¼š</strong></p>
                        <table>
                            <tr>
                                <th>åŠ©è®°ç¬¦</th>
                                <th>æ“ä½œç </th>
                                <th>åŠŸèƒ½</th>
                                <th>ç¤ºä¾‹</th>
                            </tr>
                            <tr>
                                <td>MMUL</td>
                                <td>0x0</td>
                                <td>çŸ©é˜µä¹˜æ³•</td>
                                <td>MMUL R0, M1, M2</td>
                            </tr>
                            <tr>
                                <td>CONV</td>
                                <td>0x1</td>
                                <td>å·ç§¯è¿ç®—</td>
                                <td>CONV R0, I1, W1</td>
                            </tr>
                            <tr>
                                <td>MADD</td>
                                <td>0x2</td>
                                <td>çŸ©é˜µåŠ æ³•</td>
                                <td>MADD R0, M1, M2</td>
                            </tr>
                            <tr>
                                <td>ACTV</td>
                                <td>0x3</td>
                                <td>æ¿€æ´»å‡½æ•°</td>
                                <td>ACTV.RELU R0, R1</td>
                            </tr>
                            <tr>
                                <td>POOL</td>
                                <td>0x4</td>
                                <td>æ± åŒ–æ“ä½œ</td>
                                <td>POOL.MAX R0, I1</td>
                            </tr>
                        </table>
                        
                        <p><strong>B. æ•°æ®ä¼ è¾“æŒ‡ä»¤ï¼š</strong></p>
                        <table>
                            <tr>
                                <th>åŠ©è®°ç¬¦</th>
                                <th>æ“ä½œç </th>
                                <th>åŠŸèƒ½</th>
                                <th>ç¤ºä¾‹</th>
                            </tr>
                            <tr>
                                <td>LOAD</td>
                                <td>0x8</td>
                                <td>ä»å†…å­˜åŠ è½½</td>
                                <td>LOAD R0, [ADDR]</td>
                            </tr>
                            <tr>
                                <td>STORE</td>
                                <td>0x9</td>
                                <td>å­˜å‚¨åˆ°å†…å­˜</td>
                                <td>STORE [ADDR], R0</td>
                            </tr>
                            <tr>
                                <td>DMA</td>
                                <td>0xA</td>
                                <td>DMAä¼ è¾“</td>
                                <td>DMA DST, SRC, LEN</td>
                            </tr>
                            <tr>
                                <td>BCAST</td>
                                <td>0xB</td>
                                <td>å¹¿æ’­æ•°æ®</td>
                                <td>BCAST R0, VAL</td>
                            </tr>
                        </table>
                        
                        <p><strong>C. æ§åˆ¶æŒ‡ä»¤ï¼š</strong></p>
                        <table>
                            <tr>
                                <th>åŠ©è®°ç¬¦</th>
                                <th>æ“ä½œç </th>
                                <th>åŠŸèƒ½</th>
                                <th>ç¤ºä¾‹</th>
                            </tr>
                            <tr>
                                <td>SYNC</td>
                                <td>0xC</td>
                                <td>åŒæ­¥å±éšœ</td>
                                <td>SYNC</td>
                            </tr>
                            <tr>
                                <td>LOOP</td>
                                <td>0xD</td>
                                <td>å¾ªç¯æ§åˆ¶</td>
                                <td>LOOP CNT, LABEL</td>
                            </tr>
                            <tr>
                                <td>JUMP</td>
                                <td>0xE</td>
                                <td>è·³è½¬</td>
                                <td>JUMP LABEL</td>
                            </tr>
                            <tr>
                                <td>HALT</td>
                                <td>0xF</td>
                                <td>åœæ­¢æ‰§è¡Œ</td>
                                <td>HALT</td>
                            </tr>
                        </table>
                        
                        <p><strong>3. å¯„å­˜å™¨ç»„ç»‡ï¼š</strong></p>
                        <div class="code-block">
// é€šç”¨å¯„å­˜å™¨
R0-R31: 32ä¸ªé€šç”¨å¯„å­˜å™¨ï¼ˆæ ‡é‡ï¼‰
M0-M15: 16ä¸ªçŸ©é˜µå¯„å­˜å™¨ï¼ˆæ¯ä¸ªå¯å­˜å‚¨32Ã—32çŸ©é˜µï¼‰
V0-V15: 16ä¸ªå‘é‡å¯„å­˜å™¨ï¼ˆæ¯ä¸ª256å…ƒç´ ï¼‰

// ç‰¹æ®Šå¯„å­˜å™¨
PC:     ç¨‹åºè®¡æ•°å™¨
SP:     æ ˆæŒ‡é’ˆ
STATUS: çŠ¶æ€å¯„å­˜å™¨
CONFIG: é…ç½®å¯„å­˜å™¨ï¼ˆç²¾åº¦æ¨¡å¼ç­‰ï¼‰
                        </div>
                        
                        <p><strong>4. ç¤ºä¾‹ç¨‹åºï¼ˆå·ç§¯å±‚ï¼‰ï¼š</strong></p>
                        <div class="code-block">
// æ‰§è¡Œä¸€ä¸ª3Ã—3å·ç§¯å±‚
// è¾“å…¥: I0, æƒé‡: W0, è¾“å‡º: O0

    // é…ç½®å·ç§¯å‚æ•°
    LOAD  R0, #3        // å·ç§¯æ ¸å¤§å°
    LOAD  R1, #1        // stride
    LOAD  R2, #1        // padding
    
    // åŠ è½½æ•°æ®
    DMA   M0, [input_addr], #input_size
    DMA   M1, [weight_addr], #weight_size
    
    // æ‰§è¡Œå·ç§¯
    CONV  M2, M0, M1    // ä½¿ç”¨é…ç½®çš„å‚æ•°
    
    // åº”ç”¨æ¿€æ´»å‡½æ•°
    ACTV.RELU M3, M2
    
    // å­˜å‚¨ç»“æœ
    DMA   [output_addr], M3, #output_size
    
    // åŒæ­¥ç¡®ä¿å®Œæˆ
    SYNC
    HALT
                        </div>
                        
                        <p><strong>5. ISAç‰¹ç‚¹ï¼š</strong></p>
                        <ul>
                            <li><strong>CISCé£æ ¼ï¼š</strong>å•æ¡æŒ‡ä»¤å®Œæˆå¤æ‚æ“ä½œ</li>
                            <li><strong>æ•°æ®å¹¶è¡Œï¼š</strong>åŸç”Ÿæ”¯æŒçŸ©é˜µ/å‘é‡æ“ä½œ</li>
                            <li><strong>å†…å­˜å±‚æ¬¡æ„ŸçŸ¥ï¼š</strong>æ˜¾å¼DMAç®¡ç†</li>
                            <li><strong>çµæ´»ç²¾åº¦ï¼š</strong>é€šè¿‡FLAGSæ”¯æŒå¤šç²¾åº¦</li>
                            <li><strong>ç¡¬ä»¶åŠ é€Ÿï¼š</strong>ç›´æ¥æ˜ å°„åˆ°ç¡¬ä»¶å•å…ƒ</li>
                        </ul>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®3.8ï¼š</strong>è¯„ä¼°ä¸åŒçš„åŠŸè€—ä¼˜åŒ–æŠ€æœ¯å¯¹NPUçš„å½±å“ã€‚ç»™å®šä¸€ä¸ª100 TOPSçš„NPUï¼Œåˆ†æå„ç§æŠ€æœ¯çš„èŠ‚èƒ½æ½œåŠ›ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šä»åŠ¨æ€åŠŸè€—ï¼ˆå¼€å…³æ´»åŠ¨ï¼‰å’Œé™æ€åŠŸè€—ï¼ˆæ¼ç”µæµï¼‰ä¸¤æ–¹é¢åˆ†æã€‚è€ƒè™‘æ—¶é’Ÿé—¨æ§ã€ç”µå‹é¢‘ç‡è°ƒèŠ‚ï¼ˆDVFSï¼‰ã€æ•°æ®ç²¾åº¦ä¼˜åŒ–ã€ç¨€ç–æ€§åˆ©ç”¨ç­‰æŠ€æœ¯ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <p><strong>åŸºå‡†NPUè§„æ ¼ï¼š</strong></p>
                        <ul>
                            <li>å³°å€¼æ€§èƒ½ï¼š100 TOPS (INT8)</li>
                            <li>åŠŸè€—ï¼š50W (2 TOPS/W)</li>
                            <li>å·¥è‰ºï¼š7nm</li>
                            <li>é¢‘ç‡ï¼š1GHz</li>
                        </ul>
                        
                        <p><strong>åŠŸè€—ä¼˜åŒ–æŠ€æœ¯åˆ†æï¼š</strong></p>
                        <table>
                            <tr>
                                <th>ä¼˜åŒ–æŠ€æœ¯</th>
                                <th>åŸç†</th>
                                <th>èŠ‚èƒ½æ½œåŠ›</th>
                                <th>æ€§èƒ½å½±å“</th>
                                <th>å®ç°å¤æ‚åº¦</th>
                            </tr>
                            <tr>
                                <td>æ—¶é’Ÿé—¨æ§</td>
                                <td>å…³é—­ç©ºé—²å•å…ƒæ—¶é’Ÿ</td>
                                <td>10-20%</td>
                                <td>æ— </td>
                                <td>ä½</td>
                            </tr>
                            <tr>
                                <td>ç”µæºé—¨æ§</td>
                                <td>å…³é—­ç©ºé—²å•å…ƒç”µæº</td>
                                <td>20-30%</td>
                                <td>å”¤é†’å»¶è¿Ÿ</td>
                                <td>ä¸­</td>
                            </tr>
                            <tr>
                                <td>DVFS</td>
                                <td>åŠ¨æ€è°ƒèŠ‚ç”µå‹é¢‘ç‡</td>
                                <td>30-40%</td>
                                <td>æ€§èƒ½ä¸‹é™</td>
                                <td>ä¸­</td>
                            </tr>
                            <tr>
                                <td>è¿‘é˜ˆå€¼è®¡ç®—</td>
                                <td>é™ä½å·¥ä½œç”µå‹</td>
                                <td>50-70%</td>
                                <td>é¢‘ç‡é™ä½</td>
                                <td>é«˜</td>
                            </tr>
                            <tr>
                                <td>æ•°æ®å‹ç¼©</td>
                                <td>å‡å°‘æ•°æ®ä¼ è¾“</td>
                                <td>15-25%</td>
                                <td>è½»å¾®</td>
                                <td>ä¸­</td>
                            </tr>
                            <tr>
                                <td>ç¨€ç–è®¡ç®—</td>
                                <td>è·³è¿‡é›¶å€¼è¿ç®—</td>
                                <td>20-60%</td>
                                <td>ä¾èµ–ç¨€ç–åº¦</td>
                                <td>é«˜</td>
                            </tr>
                            <tr>
                                <td>ç²¾åº¦ç¼©æ”¾</td>
                                <td>åŠ¨æ€è°ƒæ•´ç²¾åº¦</td>
                                <td>25-40%</td>
                                <td>ç²¾åº¦æŸå¤±</td>
                                <td>ä¸­</td>
                            </tr>
                        </table>
                        
                        <p><strong>åŠŸè€—åˆ†è§£ï¼ˆ50Wæ€»åŠŸè€—ï¼‰ï¼š</strong></p>
                        <div class="code-block">
è®¡ç®—å•å…ƒï¼š    20W (40%)
â”œâ”€â”€ MACé˜µåˆ—ï¼š 15W
â””â”€â”€ å‘é‡å•å…ƒï¼š 5W

å­˜å‚¨ç³»ç»Ÿï¼š    15W (30%)
â”œâ”€â”€ SRAMï¼š    10W
â””â”€â”€ æ¥å£ï¼š     5W

äº’è¿ç½‘ç»œï¼š     8W (16%)

æ§åˆ¶é€»è¾‘ï¼š     4W (8%)

IOæ¥å£ï¼š       3W (6%)
                        </div>
                        
                        <p><strong>ç»„åˆä¼˜åŒ–æ–¹æ¡ˆï¼š</strong></p>
                        <ol>
                            <li><strong>æ–¹æ¡ˆAï¼ˆä¿å®ˆå‹ï¼‰ï¼š</strong>
                                <ul>
                                    <li>æ—¶é’Ÿé—¨æ§ + åŸºç¡€DVFS</li>
                                    <li>é¢„æœŸèŠ‚èƒ½ï¼š25%</li>
                                    <li>åŠŸè€—é™è‡³ï¼š37.5W</li>
                                    <li>èƒ½æ•ˆæå‡è‡³ï¼š2.67 TOPS/W</li>
                                </ul>
                            </li>
                            <li><strong>æ–¹æ¡ˆBï¼ˆå¹³è¡¡å‹ï¼‰ï¼š</strong>
                                <ul>
                                    <li>æ—¶é’Ÿ/ç”µæºé—¨æ§ + DVFS + æ•°æ®å‹ç¼©</li>
                                    <li>é¢„æœŸèŠ‚èƒ½ï¼š45%</li>
                                    <li>åŠŸè€—é™è‡³ï¼š27.5W</li>
                                    <li>èƒ½æ•ˆæå‡è‡³ï¼š3.64 TOPS/W</li>
                                </ul>
                            </li>
                            <li><strong>æ–¹æ¡ˆCï¼ˆæ¿€è¿›å‹ï¼‰ï¼š</strong>
                                <ul>
                                    <li>å…¨éƒ¨æŠ€æœ¯ç»„åˆ + è¿‘é˜ˆå€¼è®¡ç®—</li>
                                    <li>é¢„æœŸèŠ‚èƒ½ï¼š70%</li>
                                    <li>åŠŸè€—é™è‡³ï¼š15Wï¼ˆä½†æ€§èƒ½é™è‡³70 TOPSï¼‰</li>
                                    <li>èƒ½æ•ˆæå‡è‡³ï¼š4.67 TOPS/W</li>
                                </ul>
                            </li>
                        </ol>
                        
                        <p><strong>å®æ–½å»ºè®®ï¼š</strong></p>
                        <ul>
                            <li>ä¼˜å…ˆå®æ–½ä½å¤æ‚åº¦é«˜æ”¶ç›ŠæŠ€æœ¯ï¼ˆæ—¶é’Ÿé—¨æ§ï¼‰</li>
                            <li>æ ¹æ®åº”ç”¨åœºæ™¯é€‰æ‹©DVFSç­–ç•¥</li>
                            <li>ç¨€ç–è®¡ç®—éœ€è¦è½¯ç¡¬ä»¶ååŒä¼˜åŒ–</li>
                            <li>è€ƒè™‘åŠŸè€—-æ€§èƒ½-é¢ç§¯(PPA)å¹³è¡¡</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <h3>3.5 Transformerä¸“ç”¨æ¶æ„è®¾è®¡</h3>
            
            <p>Transformeræ¨¡å‹çš„ç‹¬ç‰¹è®¡ç®—æ¨¡å¼éœ€è¦ä¸“é—¨çš„æ¶æ„ä¼˜åŒ–ã€‚ä¸CNNä¸»è¦ä¾èµ–å·ç§¯è¿ç®—ä¸åŒï¼ŒTransformerçš„è‡ªæ³¨æ„åŠ›æœºåˆ¶å¸¦æ¥äº†æ–°çš„æ¶æ„è®¾è®¡æŒ‘æˆ˜ã€‚</p>
            
            <h4>3.5.1 æ³¨æ„åŠ›è®¡ç®—çš„æ¶æ„æŒ‘æˆ˜</h4>
            <p>è‡ªæ³¨æ„åŠ›è®¡ç®—çš„ç‰¹ç‚¹å¯¹NPUæ¶æ„è®¾è®¡æå‡ºäº†ç‹¬ç‰¹è¦æ±‚ï¼š</p>
            
            <div class="info-box">
                <p><strong>Transformer vs CNNè®¡ç®—ç‰¹å¾å¯¹æ¯”ï¼š</strong></p>
                <table>
                    <thead>
                        <tr>
                            <th>ç‰¹å¾</th>
                            <th>CNN</th>
                            <th>Transformer</th>
                            <th>æ¶æ„å½±å“</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>è®¡ç®—æ¨¡å¼</td>
                            <td>å±€éƒ¨è¿æ¥ï¼Œæƒé‡å…±äº«</td>
                            <td>å…¨å±€è¿æ¥ï¼ŒåŠ¨æ€æƒé‡</td>
                            <td>éœ€è¦æ›´å¤§çš„ç‰‡ä¸Šå­˜å‚¨</td>
                        </tr>
                        <tr>
                            <td>å†…å­˜è®¿é—®</td>
                            <td>è§„å¾‹çš„æ»‘çª—æ¨¡å¼</td>
                            <td>ä¸è§„åˆ™çš„å…¨å±€è®¿é—®</td>
                            <td>éœ€è¦çµæ´»çš„å†…å­˜ç³»ç»Ÿ</td>
                        </tr>
                        <tr>
                            <td>è®¡ç®—å¤æ‚åº¦</td>
                            <td>O(N)</td>
                            <td>O(NÂ²)</td>
                            <td>éœ€è¦æ›´å¼ºçš„è®¡ç®—èƒ½åŠ›</td>
                        </tr>
                        <tr>
                            <td>æ•°æ®å¤ç”¨</td>
                            <td>é«˜ï¼ˆæƒé‡å¤ç”¨ï¼‰</td>
                            <td>ä½ï¼ˆåŠ¨æ€æ³¨æ„åŠ›ï¼‰</td>
                            <td>éœ€è¦æ–°çš„æ•°æ®æµè®¾è®¡</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <h4>3.5.2 TransformeråŠ é€Ÿå™¨æ¶æ„</h4>
            <p>é’ˆå¯¹Transformerçš„ç‰¹ç‚¹ï¼Œç°ä»£NPUé‡‡ç”¨äº†å¤šç§æ¶æ„åˆ›æ–°ï¼š</p>
            
            <div class="code-block">
// Transformerä¸“ç”¨NPUæ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ§åˆ¶å•å…ƒ (Controller)           â”‚
â”‚  - æ³¨æ„åŠ›è°ƒåº¦å™¨                         â”‚
â”‚  - åŠ¨æ€åˆ†å—æ§åˆ¶                         â”‚
â”‚  - å¤šå¤´å¹¶è¡Œç®¡ç†                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ä¸“ç”¨è®¡ç®—å¼•æ“ (Compute Engines)      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚  GEMMå¼•æ“   â”‚ â”‚ Softmaxå¼•æ“ â”‚       â”‚
â”‚ â”‚ - QKè®¡ç®—    â”‚ â”‚ - æŒ‡æ•°å•å…ƒ  â”‚       â”‚
â”‚ â”‚ - PVè®¡ç®—    â”‚ â”‚ - å½’ä¸€åŒ–å™¨  â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚ å±‚å½’ä¸€åŒ–    â”‚ â”‚  ç‰¹æ®Šå‡½æ•°   â”‚       â”‚
â”‚ â”‚   å¼•æ“      â”‚ â”‚    å•å…ƒ     â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      å±‚æ¬¡åŒ–å­˜å‚¨ç³»ç»Ÿ (Memory)            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚     æ³¨æ„åŠ›ç¼“å­˜ (Att Cache)  â”‚         â”‚
â”‚ â”‚   - KV Cache: 512KB         â”‚         â”‚
â”‚ â”‚   - Score Buffer: 256KB     â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚    å…¨å±€ç¼“å†²åŒº (L2 Buffer)   â”‚         â”‚
â”‚ â”‚   - ç»Ÿä¸€åœ°å€ç©ºé—´: 2MB       â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>
            
            <h4>3.5.3 KV Cacheä¼˜åŒ–æ¶æ„</h4>
            <p>åœ¨Transformeræ¨ç†ä¸­ï¼ŒKV Cacheæ˜¯å…³é”®çš„æ€§èƒ½ç“¶é¢ˆã€‚ä¸“ç”¨çš„ç¼“å­˜æ¶æ„å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ï¼š</p>
            
            <div class="code-block">
// KV Cacheç®¡ç†å•å…ƒ
module KVCacheManager #(
    parameter MAX_SEQ_LEN = 8192,
    parameter D_MODEL = 1024,
    parameter NUM_HEADS = 16,
    parameter CACHE_WAYS = 4
)(
    input wire clk,
    input wire rst_n,
    
    // è¯·æ±‚æ¥å£
    input wire cache_req,
    input wire cache_write,
    input wire [12:0] seq_pos,      // åºåˆ—ä½ç½®
    input wire [3:0] head_idx,       // æ³¨æ„åŠ›å¤´ç´¢å¼•
    input wire [9:0] dim_idx,        // ç»´åº¦ç´¢å¼•
    
    // æ•°æ®æ¥å£
    input wire [15:0] write_data,    // FP16
    output reg [15:0] read_data,
    output reg cache_hit,
    
    // é¢„å–æ¥å£
    input wire prefetch_enable,
    input wire [12:0] prefetch_pos
);
    
    // åˆ†ç»„å…³è”ç¼“å­˜ç»“æ„
    localparam CACHE_SETS = MAX_SEQ_LEN / CACHE_WAYS;
    localparam D_HEAD = D_MODEL / NUM_HEADS;
    
    // ç¼“å­˜å­˜å‚¨
    reg [15:0] k_cache [CACHE_SETS-1:0][CACHE_WAYS-1:0][D_HEAD-1:0];
    reg [15:0] v_cache [CACHE_SETS-1:0][CACHE_WAYS-1:0][D_HEAD-1:0];
    
    // æ ‡ç­¾å’Œæœ‰æ•ˆä½
    reg [12:0] cache_tags [CACHE_SETS-1:0][CACHE_WAYS-1:0];
    reg cache_valid [CACHE_SETS-1:0][CACHE_WAYS-1:0];
    
    // LRUæ›¿æ¢ç­–ç•¥
    reg [1:0] lru_counter [CACHE_SETS-1:0][CACHE_WAYS-1:0];
    
    // åœ°å€è§£ç 
    wire [9:0] set_idx = seq_pos[9:0];
    wire [2:0] tag = seq_pos[12:10];
    
    // å‘½ä¸­æ£€æµ‹
    integer way;
    reg [1:0] hit_way;
    always @(*) begin
        cache_hit = 1'b0;
        hit_way = 2'b00;
        for (way = 0; way < CACHE_WAYS; way = way + 1) begin
            if (cache_valid[set_idx][way] && 
                cache_tags[set_idx][way] == tag) begin
                cache_hit = 1'b1;
                hit_way = way;
            end
        end
    end
    
    // ç¼“å­˜è®¿é—®
    always @(posedge clk) begin
        if (!rst_n) begin
            // åˆå§‹åŒ–
            for (int i = 0; i < CACHE_SETS; i++) begin
                for (int j = 0; j < CACHE_WAYS; j++) begin
                    cache_valid[i][j] <= 1'b0;
                    lru_counter[i][j] <= 2'b00;
                end
            end
        end else if (cache_req) begin
            if (cache_write) begin
                if (cache_hit) begin
                    // å†™å‘½ä¸­ï¼šæ›´æ–°æ•°æ®
                    k_cache[set_idx][hit_way][dim_idx] <= write_data;
                    // æ›´æ–°LRU
                    lru_counter[set_idx][hit_way] <= 2'b11;
                end else begin
                    // å†™ç¼ºå¤±ï¼šåˆ†é…æ–°è¡Œ
                    // æ‰¾LRU way
                    reg [1:0] lru_way = 0;
                    reg [1:0] min_lru = 2'b11;
                    for (way = 0; way < CACHE_WAYS; way = way + 1) begin
                        if (lru_counter[set_idx][way] < min_lru) begin
                            min_lru = lru_counter[set_idx][way];
                            lru_way = way;
                        end
                    end
                    
                    // å†™å…¥æ–°æ•°æ®
                    k_cache[set_idx][lru_way][dim_idx] <= write_data;
                    cache_tags[set_idx][lru_way] <= tag;
                    cache_valid[set_idx][lru_way] <= 1'b1;
                    lru_counter[set_idx][lru_way] <= 2'b11;
                end
            end else begin
                // è¯»æ“ä½œ
                if (cache_hit) begin
                    read_data <= k_cache[set_idx][hit_way][dim_idx];
                    // æ›´æ–°LRU
                    lru_counter[set_idx][hit_way] <= 2'b11;
                end
            end
            
            // è€åŒ–LRUè®¡æ•°å™¨
            for (way = 0; way < CACHE_WAYS; way = way + 1) begin
                if (way != hit_way && lru_counter[set_idx][way] > 0) begin
                    lru_counter[set_idx][way] <= lru_counter[set_idx][way] - 1;
                end
            end
        end
    end
    
    // é¢„å–é€»è¾‘
    reg [12:0] prefetch_addr;
    reg prefetch_active;
    
    always @(posedge clk) begin
        if (!rst_n) begin
            prefetch_active <= 1'b0;
        end else if (prefetch_enable && !cache_req) begin
            // åœ¨ç©ºé—²æ—¶æ‰§è¡Œé¢„å–
            prefetch_active <= 1'b1;
            prefetch_addr <= prefetch_pos;
            // å®é™…é¢„å–é€»è¾‘éœ€è¦è¿æ¥åˆ°å†…å­˜ç³»ç»Ÿ
        end
    end
endmodule
            </div>
            
            <h4>3.5.4 åŠ¨æ€åºåˆ—é•¿åº¦æ”¯æŒ</h4>
            <p>Transformerçš„åºåˆ—é•¿åº¦å¯å˜ç‰¹æ€§éœ€è¦çµæ´»çš„æ¶æ„æ”¯æŒï¼š</p>
            
            <div class="info-box">
                <p><strong>åºåˆ—é•¿åº¦è‡ªé€‚åº”ç­–ç•¥ï¼š</strong></p>
                <ul>
                    <li><strong>åˆ†æ®µå¤„ç†ï¼š</strong>å°†é•¿åºåˆ—åˆ†æˆå›ºå®šå¤§å°çš„æ®µï¼Œæ¯æ®µç‹¬ç«‹å¤„ç†</li>
                    <li><strong>åŠ¨æ€åˆ†å—ï¼š</strong>æ ¹æ®åºåˆ—é•¿åº¦åŠ¨æ€è°ƒæ•´å—å¤§å°ï¼Œå¹³è¡¡å†…å­˜å’Œè®¡ç®—</li>
                    <li><strong>ç¨€ç–æ³¨æ„åŠ›ï¼š</strong>åªè®¡ç®—é‡è¦çš„æ³¨æ„åŠ›è¿æ¥ï¼Œå‡å°‘è®¡ç®—é‡</li>
                    <li><strong>æ»‘çª—æ³¨æ„åŠ›ï¼š</strong>é™åˆ¶æ³¨æ„åŠ›èŒƒå›´åœ¨å±€éƒ¨çª—å£å†…</li>
                </ul>
            </div>
            
            <h4>3.5.5 å¤šæ¨¡æ€èåˆæ¶æ„</h4>
            <p>ç°ä»£Transformeréœ€è¦å¤„ç†å¤šç§æ¨¡æ€ï¼ˆæ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ï¼‰ï¼Œè¿™éœ€è¦ç»Ÿä¸€çš„æ¶æ„è®¾è®¡ï¼š</p>
            
            <div class="code-block">
// å¤šæ¨¡æ€Transformerå¤„ç†å•å…ƒ
module MultiModalProcessor #(
    parameter MAX_TEXT_LEN = 2048,
    parameter MAX_IMAGE_PATCHES = 1024,
    parameter D_MODEL = 768
)(
    input wire clk,
    input wire rst_n,
    
    // æ¨¡æ€é€‰æ‹©
    input wire [1:0] modality,  // 0:æ–‡æœ¬ 1:å›¾åƒ 2:éŸ³é¢‘ 3:èåˆ
    
    // æ–‡æœ¬è¾“å…¥
    input wire [15:0] text_embeddings [MAX_TEXT_LEN-1:0][D_MODEL-1:0],
    input wire [10:0] text_len,
    
    // å›¾åƒè¾“å…¥ï¼ˆpatch embeddingsï¼‰
    input wire [15:0] image_patches [MAX_IMAGE_PATCHES-1:0][D_MODEL-1:0],
    input wire [9:0] num_patches,
    
    // ä½ç½®ç¼–ç ç”Ÿæˆå™¨
    output reg [15:0] position_encoding [2047:0][D_MODEL-1:0]
);
    
    // ç»Ÿä¸€çš„embeddingæŠ•å½±
    reg [15:0] unified_embeddings [4095:0][D_MODEL-1:0];
    reg [11:0] total_len;
    
    // æ¨¡æ€ç‰¹å®šçš„ä½ç½®ç¼–ç 
    always @(posedge clk) begin
        case (modality)
            2'b00: begin  // æ–‡æœ¬ï¼š1Dä½ç½®ç¼–ç 
                for (int i = 0; i < text_len; i++) begin
                    for (int j = 0; j < D_MODEL; j++) begin
                        if (j[0] == 0) begin
                            // å¶æ•°ç»´åº¦ï¼šsin(pos/10000^(2i/d_model))
                            position_encoding[i][j] <= $sin(i / (10000.0 ** (j/D_MODEL)));
                        end else begin
                            // å¥‡æ•°ç»´åº¦ï¼šcos(pos/10000^(2i/d_model))
                            position_encoding[i][j] <= $cos(i / (10000.0 ** ((j-1)/D_MODEL)));
                        end
                    end
                end
                total_len <= text_len;
            end
            
            2'b01: begin  // å›¾åƒï¼š2Dä½ç½®ç¼–ç 
                for (int p = 0; p < num_patches; p++) begin
                    int row = p / 32;  // å‡è®¾32x32 patches
                    int col = p % 32;
                    for (int j = 0; j < D_MODEL/2; j++) begin
                        // è¡Œç¼–ç 
                        position_encoding[p][j*2] <= $sin(row / (10000.0 ** (j/(D_MODEL/2))));
                        // åˆ—ç¼–ç 
                        position_encoding[p][j*2+1] <= $sin(col / (10000.0 ** (j/(D_MODEL/2))));
                    end
                end
                total_len <= num_patches;
            end
            
            2'b11: begin  // å¤šæ¨¡æ€èåˆ
                // æ–‡æœ¬éƒ¨åˆ†
                for (int i = 0; i < text_len; i++) begin
                    unified_embeddings[i] <= text_embeddings[i];
                end
                // å›¾åƒéƒ¨åˆ†ï¼ˆè¿½åŠ ï¼‰
                for (int i = 0; i < num_patches; i++) begin
                    unified_embeddings[text_len + i] <= image_patches[i];
                end
                total_len <= text_len + num_patches;
                
                // ç”Ÿæˆèåˆçš„ä½ç½®ç¼–ç 
                // å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ï¼Œå¦‚ç›¸å¯¹ä½ç½®ç¼–ç 
            end
        endcase
    end
    
    // è·¨æ¨¡æ€æ³¨æ„åŠ›æ©ç ç”Ÿæˆ
    reg attention_mask [4095:0][4095:0];
    
    always @(posedge clk) begin
        if (modality == 2'b11) begin  // èåˆæ¨¡å¼
            // å…è®¸è·¨æ¨¡æ€æ³¨æ„åŠ›
            for (int i = 0; i < total_len; i++) begin
                for (int j = 0; j < total_len; j++) begin
                    if (i < text_len && j >= text_len) begin
                        // æ–‡æœ¬å¯ä»¥å…³æ³¨å›¾åƒ
                        attention_mask[i][j] <= 1'b1;
                    end else if (i >= text_len && j < text_len) begin
                        // å›¾åƒå¯ä»¥å…³æ³¨æ–‡æœ¬
                        attention_mask[i][j] <= 1'b1;
                    end else begin
                        // æ¨¡æ€å†…æ³¨æ„åŠ›å§‹ç»ˆå…è®¸
                        attention_mask[i][j] <= 1'b1;
                    end
                end
            end
        end
    end
endmodule
            </div>
            
            <div class="exercise">
                <h4>ç»ƒä¹  3.5</h4>
                <div class="question">
                    <p><strong>é¢˜ç›®ï¼š</strong>è®¾è®¡ä¸€ä¸ªæ”¯æŒåŠ¨æ€æ‰¹å¤„ç†çš„TransformeråŠ é€Ÿå™¨æ¶æ„ï¼Œè¦æ±‚ï¼š
                    1) æ”¯æŒå¯å˜çš„æ‰¹å¤§å°ï¼ˆ1-32ï¼‰
                    2) æ”¯æŒä¸åŒåºåˆ—é•¿åº¦çš„paddingå’Œmask
                    3) å®ç°é«˜æ•ˆçš„æ‰¹å†…å¹¶è¡Œå’Œæ‰¹é—´æµæ°´
                    4) è€ƒè™‘å†…å­˜å¸¦å®½ä¼˜åŒ–</p>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <div class="code-block">
module DynamicBatchTransformer #(
    parameter MAX_BATCH_SIZE = 32,
    parameter MAX_SEQ_LEN = 512,
    parameter D_MODEL = 768,
    parameter NUM_HEADS = 12,
    parameter NUM_PE = 256  // å¤„ç†å•å…ƒæ•°é‡
)(
    input wire clk,
    input wire rst_n,
    
    // æ‰¹å¤„ç†é…ç½®
    input wire [4:0] batch_size,          // 1-32
    input wire [8:0] seq_lengths [MAX_BATCH_SIZE-1:0],  // æ¯ä¸ªæ ·æœ¬çš„é•¿åº¦
    input wire batch_start,
    
    // è¾“å…¥æ•°æ®æ¥å£
    input wire [15:0] input_data,
    input wire input_valid,
    input wire [4:0] sample_idx,
    input wire [8:0] token_idx,
    
    // è¾“å‡ºæ¥å£
    output reg [15:0] output_data,
    output reg output_valid,
    output reg [4:0] output_sample_idx,
    output reg [8:0] output_token_idx,
    output reg batch_done
);
    
    // æ‰¹å¤„ç†è°ƒåº¦å™¨
    reg [2:0] batch_state;
    localparam IDLE = 3'b000;
    localparam SCHEDULE = 3'b001;
    localparam PROCESS = 3'b010;
    localparam COLLECT = 3'b011;
    
    // å·¥ä½œåˆ†é…è¡¨
    reg [4:0] pe_assignment [NUM_PE-1:0];  // PEåˆ°æ ·æœ¬çš„æ˜ å°„
    reg [8:0] pe_token_start [NUM_PE-1:0]; // æ¯ä¸ªPEå¤„ç†çš„èµ·å§‹token
    reg [8:0] pe_token_end [NUM_PE-1:0];   // æ¯ä¸ªPEå¤„ç†çš„ç»“æŸtoken
    reg pe_active [NUM_PE-1:0];
    
    // Paddingæ©ç ç”Ÿæˆ
    reg padding_mask [MAX_BATCH_SIZE-1:0][MAX_SEQ_LEN-1:0];
    
    always @(posedge clk) begin
        if (!rst_n) begin
            batch_state <= IDLE;
            batch_done <= 1'b0;
        end else begin
            case (batch_state)
                IDLE: begin
                    if (batch_start) begin
                        batch_state <= SCHEDULE;
                        batch_done <= 1'b0;
                        
                        // ç”Ÿæˆpaddingæ©ç 
                        for (int b = 0; b < MAX_BATCH_SIZE; b++) begin
                            for (int s = 0; s < MAX_SEQ_LEN; s++) begin
                                if (b < batch_size && s < seq_lengths[b]) begin
                                    padding_mask[b][s] <= 1'b1;  // æœ‰æ•ˆä½ç½®
                                end else begin
                                    padding_mask[b][s] <= 1'b0;  // Paddingä½ç½®
                                end
                            end
                        end
                    end
                end
                
                SCHEDULE: begin
                    // åŠ¨æ€å·¥ä½œåˆ†é…ç®—æ³•
                    schedule_work();
                    batch_state <= PROCESS;
                end
                
                PROCESS: begin
                    // ç­‰å¾…æ‰€æœ‰PEå®Œæˆ
                    if (all_pe_done()) begin
                        batch_state <= COLLECT;
                    end
                end
                
                COLLECT: begin
                    batch_done <= 1'b1;
                    batch_state <= IDLE;
                end
            endcase
        end
    end
    
    // å·¥ä½œè°ƒåº¦å‡½æ•°
    task schedule_work;
        integer total_tokens;
        integer tokens_per_pe;
        integer current_pe;
        integer assigned_tokens;
        begin
            // è®¡ç®—æ€»tokenæ•°
            total_tokens = 0;
            for (int b = 0; b < batch_size; b++) begin
                total_tokens = total_tokens + seq_lengths[b];
            end
            
            // å¹³å‡åˆ†é…ç­–ç•¥
            tokens_per_pe = (total_tokens + NUM_PE - 1) / NUM_PE;
            
            current_pe = 0;
            assigned_tokens = 0;
            
            // åˆ†é…æ ·æœ¬å’ŒtokenèŒƒå›´åˆ°PE
            for (int b = 0; b < batch_size; b++) begin
                integer sample_start = 0;
                integer remaining = seq_lengths[b];
                
                while (remaining > 0 && current_pe < NUM_PE) begin
                    integer chunk_size;
                    
                    // ç¡®å®šå½“å‰PEå¤„ç†çš„tokenæ•°
                    if (assigned_tokens + remaining <= tokens_per_pe) begin
                        chunk_size = remaining;
                    end else begin
                        chunk_size = tokens_per_pe - assigned_tokens;
                    end
                    
                    // åˆ†é…å·¥ä½œ
                    pe_assignment[current_pe] = b;
                    pe_token_start[current_pe] = sample_start;
                    pe_token_end[current_pe] = sample_start + chunk_size;
                    pe_active[current_pe] = 1'b1;
                    
                    sample_start = sample_start + chunk_size;
                    remaining = remaining - chunk_size;
                    assigned_tokens = assigned_tokens + chunk_size;
                    
                    // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªPE
                    if (assigned_tokens >= tokens_per_pe) begin
                        current_pe = current_pe + 1;
                        assigned_tokens = 0;
                    end
                end
            end
            
            // æ ‡è®°æœªä½¿ç”¨çš„PE
            for (int p = current_pe; p < NUM_PE; p++) begin
                pe_active[p] = 1'b0;
            end
        end
    endtask
    
    // æ£€æŸ¥æ‰€æœ‰PEæ˜¯å¦å®Œæˆ
    function all_pe_done;
        begin
            all_pe_done = 1'b1;
            for (int p = 0; p < NUM_PE; p++) begin
                if (pe_active[p] && !pe_done[p]) begin
                    all_pe_done = 1'b0;
                end
            end
        end
    endfunction
    
    // PEé˜µåˆ—å®ä¾‹åŒ–
    wire pe_done [NUM_PE-1:0];
    
    genvar pe_idx;
    generate
        for (pe_idx = 0; pe_idx < NUM_PE; pe_idx = pe_idx + 1) begin : pe_array
            TransformerPE #(
                .D_MODEL(D_MODEL),
                .NUM_HEADS(NUM_HEADS)
            ) pe_inst (
                .clk(clk),
                .rst_n(rst_n),
                .enable(pe_active[pe_idx]),
                .sample_idx(pe_assignment[pe_idx]),
                .token_start(pe_token_start[pe_idx]),
                .token_end(pe_token_end[pe_idx]),
                .padding_mask(padding_mask[pe_assignment[pe_idx]]),
                .done(pe_done[pe_idx])
            );
        end
    endgenerate
    
    // å†…å­˜å¸¦å®½ä¼˜åŒ–ï¼šæ‰¹å†…æ•°æ®é¢„å–
    reg [15:0] prefetch_buffer [MAX_BATCH_SIZE-1:0][63:0][D_MODEL-1:0];
    reg [5:0] prefetch_ptr [MAX_BATCH_SIZE-1:0];
    
    always @(posedge clk) begin
        if (batch_state == PROCESS) begin
            // é¢„å–ä¸‹ä¸€ä¸ªçª—å£çš„æ•°æ®
            for (int b = 0; b < batch_size; b++) begin
                if (prefetch_ptr[b] < seq_lengths[b]) begin
                    // å‘èµ·é¢„å–è¯·æ±‚
                    // å®é™…å®ç°éœ€è¦è¿æ¥åˆ°å†…å­˜æ§åˆ¶å™¨
                end
            end
        end
    end
    
    // ç»“æœæ”¶é›†å’Œé‡æ’åº
    reg [15:0] output_buffer [MAX_BATCH_SIZE-1:0][MAX_SEQ_LEN-1:0][D_MODEL-1:0];
    reg output_ready [MAX_BATCH_SIZE-1:0][MAX_SEQ_LEN-1:0];
    
    // è¾“å‡ºç”ŸæˆçŠ¶æ€æœº
    reg [4:0] out_sample;
    reg [8:0] out_token;
    
    always @(posedge clk) begin
        if (!rst_n) begin
            output_valid <= 1'b0;
            out_sample <= 0;
            out_token <= 0;
        end else if (batch_state == COLLECT) begin
            // æŒ‰é¡ºåºè¾“å‡ºç»“æœ
            if (out_sample < batch_size) begin
                if (out_token < seq_lengths[out_sample] && 
                    output_ready[out_sample][out_token]) begin
                    output_data <= output_buffer[out_sample][out_token][0]; // ç®€åŒ–ï¼šåªè¾“å‡ºç¬¬ä¸€ç»´
                    output_valid <= 1'b1;
                    output_sample_idx <= out_sample;
                    output_token_idx <= out_token;
                    
                    // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªtoken
                    if (out_token == seq_lengths[out_sample] - 1) begin
                        out_token <= 0;
                        out_sample <= out_sample + 1;
                    end else begin
                        out_token <= out_token + 1;
                    end
                end else begin
                    output_valid <= 1'b0;
                end
            end
        end else begin
            output_valid <= 1'b0;
        end
    end
endmodule
                        </div>
                        <p><strong>è®¾è®¡è¦ç‚¹ï¼š</strong></p>
                        <ul>
                            <li>åŠ¨æ€å·¥ä½œåˆ†é…å®ç°è´Ÿè½½å‡è¡¡</li>
                            <li>Paddingæ©ç é¿å…æ— æ•ˆè®¡ç®—</li>
                            <li>é¢„å–æœºåˆ¶ä¼˜åŒ–å†…å­˜å¸¦å®½åˆ©ç”¨</li>
                            <li>PEçº§å¹¶è¡Œå’Œæµæ°´çº¿æé«˜ååé‡</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        </div>
        
        <div class="chapter-nav">
            <a href="chapter2.html" class="prev">ä¸Šä¸€ç« </a>
            <a href="chapter4.html" class="next">ä¸‹ä¸€ç« </a>
        </div>
    </div>
</body>
</html>