## 第5章：存储系统设计

存储系统是NPU性能的关键瓶颈之一。本章深入探讨NPU片上存储系统的架构与设计要点，包括SRAM设计、Memory Banking策略、数据预取机制、缓存一致性、DMA设计以及内存压缩技术。

在现代NPU设计中，有一个残酷的事实：**数据搬运的能耗是计算的10-100倍**。从外部DRAM读取一个32位数据需要约640pJ的能量，而执行一次32位乘法仅需3.1pJ（在45nm工艺下）。这意味着，如果我们不能有效地管理数据移动，即使拥有世界上最快的计算单元也毫无意义。这就是为什么顶级NPU设计团队会花费超过50%的精力在存储系统优化上。

本章将揭示NPU存储系统设计的艺术与科学。我们将从片上SRAM的物理设计开始，探讨如何通过巧妙的Banking策略实现高带宽访问，如何设计智能的预取机制来隐藏访存延迟，以及如何通过压缩技术在有限的片上存储中塞入更多数据。更重要的是，我们将学习如何为脉动阵列这样的规则计算模式设计最优的存储层次结构。通过本章的学习，你将掌握设计高效NPU存储系统的核心技术，理解为什么Google TPU要配备如此巨大的片上存储，以及为什么NVIDIA在每一代GPU中都在不断增加缓存容量。

### 5.1 片上SRAM设计

片上SRAM是NPU存储层次结构的核心，为计算单元提供超低延迟、超高带宽的数据访问。

##### CPU时代的Scratchpad记忆

在NPU大规模采用Scratchpad内存之前，CPU领域已经有了丰富的探索历史：

  **CPU Scratchpad的历史演进**
- **IBM Cell BE (2005)：**：PlayStation 3的处理器，每个SPE（协处理器）配备256KB的本地存储（Local Store），完全由软件管理。这是最早的大规模商用Scratchpad设计。- **TI DSP系列：** 德州仪器的DSP从C6000系列开始就采用了L1P（程序）和L1D（数据）分离的Scratchpad设计，专门用于信号处理的确定性延迟。
- **ARM TCM (Tightly Coupled Memory)：**：ARM Cortex-R系列处理器的标配，提供单周期访问延迟，广泛用于汽车电子和实时控制。- **Intel Xeon Phi：** 每个核心配备512KB的本地内存，可配置为缓存或Scratchpad模式。
