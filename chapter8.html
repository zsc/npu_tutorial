<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬8ç« ï¼šç‰©ç†è®¾è®¡ - NPUè®¾è®¡æ•™ç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .nav-bar {
            background: #34495e;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-bar ul {
            list-style: none;
            display: flex;
            justify-content: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
        }

        .nav-bar li {
            margin: 0 15px;
        }

        .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .nav-bar a:hover {
            background: #2c3e50;
        }

        .nav-bar .current {
            background: #2c3e50;
            font-weight: bold;
        }

        .chapter {
            background: white;
            margin: 20px 0;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chapter h2 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .chapter h3 {
            color: #34495e;
            font-size: 1.5em;
            margin: 25px 0 15px 0;
        }

        .chapter h4 {
            color: #7f8c8d;
            font-size: 1.2em;
            margin: 20px 0 10px 0;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }
        
        /* Language label */
        .code-block::before {
            content: attr(data-language);
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: #95a5a6;
            text-transform: uppercase;
        }
        
        /* Syntax highlighting classes */
        .code-block .keyword { color: #e74c3c; font-weight: bold; }
        .code-block .type { color: #3498db; }
        .code-block .comment { color: #95a5a6; font-style: italic; }
        .code-block .number { color: #e67e22; }
        .code-block .string { color: #2ecc71; }
        .code-block .function { color: #3498db; }

        .exercise {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
        }

        .exercise h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .question {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .answer {
            margin-top: 10px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 5px;
            display: none;
            border-left: 4px solid #4caf50;
        }

        .answer.show {
            display: block;
        }
        
        .hint {
            margin: 10px 0;
            padding: 10px 15px;
            background: #fff8dc;
            border-left: 4px solid #ffa500;
            border-radius: 5px;
            font-size: 0.95em;
        }
        
        .hint summary {
            cursor: pointer;
            font-weight: bold;
            color: #ff8c00;
            outline: none;
        }
        
        .hint summary:hover {
            color: #ff6347;
        }
        
        .hint p {
            margin-top: 10px;
            color: #666;
        }

        .toggle-answer {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .toggle-answer:hover {
            background: #2980b9;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 5px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 5px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .chapter-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }

        .chapter-nav a {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .chapter-nav a:hover {
            background: #2980b9;
        }

        .chapter-nav .prev::before {
            content: "â† ";
        }

        .chapter-nav .next::after {
            content: " â†’";
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 20px 10px;
            }
            
            header h1 {
                font-size: 1.5em;
            }
            
            .chapter {
                padding: 15px;
                margin: 10px 0;
            }
            
            .chapter h2 {
                font-size: 1.5em;
            }
            
            .chapter h3 {
                font-size: 1.2em;
            }
            
            .nav-bar ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-bar li {
                margin: 5px;
            }
            
            .code-block {
                padding: 10px;
                font-size: 12px;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px;
            }
        }

        /* List styles for proper indentation */
        .chapter ul, .chapter ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .chapter li {
            margin-bottom: 8px;
            line-height: 1.8;
        }
        
        .chapter ul ul, .chapter ol ol, .chapter ul ol, .chapter ol ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .info-box ul, .warning-box ul, .answer ul {
            margin-left: 20px;
        }
        
        .info-box li, .warning-box li, .answer li {
            margin-bottom: 10px;
        }
        
        /* Keep nav-bar lists unstyled */
        .nav-bar ul {
            margin-left: 0;
        }
        
        .nav-bar li {
            margin-bottom: 0;
        }
    </style>
    <script>
        // Syntax highlighting functions
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        function highlightSyntax() {
            const codeBlocks = document.querySelectorAll('.code-block');
            
            codeBlocks.forEach(block => {
                const content = block.textContent;
                let language = 'text';
                let highlighted = content;
                
                // Auto-detect language based on content
                if (content.includes('module ') || content.includes('always @') || content.includes('wire ') || content.includes('reg ')) {
                    language = 'verilog';
                    highlighted = highlightVerilog(content);
                } else if (content.includes('import ') || content.includes('def ') || content.includes('class ')) {
                    language = 'python';
                    highlighted = highlightPython(content);
                }
                
                block.innerHTML = highlighted;
                block.classList.add(language);
                block.setAttribute('data-language', language);
            });
        }
        
        function highlightVerilog(code) {
            const placeholders = [];
            let placeholderIndex = 0;
            
            // Replace comments with placeholders
            code = code.replace(/(\/\/.*$|\/\*[\s\S]*?\*\/)/gm, (match) => {
                const placeholder = `__COMMENT_${placeholderIndex}__`;
                placeholders[placeholderIndex] = `<span class="comment">${escapeHtml(match)}</span>`;
                placeholderIndex++;
                return placeholder;
            });
            
            // Replace strings with placeholders
            code = code.replace(/("[^"]*")/g, (match) => {
                const placeholder = `__STRING_${placeholderIndex}__`;
                placeholders[placeholderIndex] = `<span class="string">${escapeHtml(match)}</span>`;
                placeholderIndex++;
                return placeholder;
            });
            
            // Apply highlights
            const keywords = /\b(module|endmodule|input|output|wire|reg|always|assign|begin|end|if|else|for|while|parameter|posedge|negedge)\b/g;
            const types = /\b(bit|logic|byte|shortint|int|longint|integer|time|real)\b/g;
            const numbers = /\b(\d+'[hbdo][\da-fA-F_]+|\d+)\b/g;
            
            code = code.replace(keywords, '<span class="keyword">$1</span>');
            code = code.replace(types, '<span class="type">$1</span>');
            code = code.replace(numbers, '<span class="number">$1</span>');
            
            // Restore placeholders
            for (let i = 0; i < placeholderIndex; i++) {
                code = code.replace(new RegExp(`__COMMENT_${i}__`, 'g'), placeholders[i]);
                code = code.replace(new RegExp(`__STRING_${i}__`, 'g'), placeholders[i]);
            }
            
            return code;
        }
        
        function highlightPython(code) {
            const placeholders = [];
            let placeholderIndex = 0;
            
            // Replace comments
            code = code.replace(/(#.*$)/gm, (match) => {
                const placeholder = `__COMMENT_${placeholderIndex}__`;
                placeholders[placeholderIndex] = `<span class="comment">${escapeHtml(match)}</span>`;
                placeholderIndex++;
                return placeholder;
            });
            
            // Replace strings
            code = code.replace(/("[^"]*"|'[^']*')/g, (match) => {
                const placeholder = `__STRING_${placeholderIndex}__`;
                placeholders[placeholderIndex] = `<span class="string">${escapeHtml(match)}</span>`;
                placeholderIndex++;
                return placeholder;
            });
            
            // Apply highlights
            const keywords = /\b(and|as|assert|break|class|continue|def|del|elif|else|except|False|finally|for|from|global|if|import|in|is|lambda|None|not|or|pass|raise|return|True|try|while|with|yield)\b/g;
            const builtins = /\b(abs|all|any|bin|bool|dict|float|format|hex|input|int|len|list|map|max|min|open|print|range|round|set|sorted|str|sum|tuple|type|zip)\b/g;
            const numbers = /\b(\d+\.?\d*)\b/g;
            
            code = code.replace(keywords, '<span class="keyword">$1</span>');
            code = code.replace(builtins, '<span class="function">$1</span>');
            code = code.replace(numbers, '<span class="number">$1</span>');
            
            // Restore placeholders
            for (let i = 0; i < placeholderIndex; i++) {
                code = code.replace(new RegExp(`__COMMENT_${i}__`, 'g'), placeholders[i]);
                code = code.replace(new RegExp(`__STRING_${i}__`, 'g'), placeholders[i]);
            }
            
            return code;
        }
        
        // Toggle answer visibility
        document.addEventListener('DOMContentLoaded', function() {
            highlightSyntax();
            
            const toggleButtons = document.querySelectorAll('.toggle-answer');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const answer = this.nextElementSibling;
                    answer.classList.toggle('show');
                    this.textContent = answer.classList.contains('show') ? 'éšè—ç­”æ¡ˆ' : 'æ˜¾ç¤ºç­”æ¡ˆ';
                });
            });
        });
    </script>
</head>
<body>
    <header>
        <h1>ç¬¬8ç« ï¼šç‰©ç†è®¾è®¡</h1>
    </header>
    
    <nav class="nav-bar">
        <ul>
            <li><a href="index.html">é¦–é¡µ</a></li>
            <li><a href="chapter1.html">ç¬¬1ç« </a></li>
            <li><a href="chapter2.html">ç¬¬2ç« </a></li>
            <li><a href="chapter3.html">ç¬¬3ç« </a></li>
            <li><a href="chapter4.html">ç¬¬4ç« </a></li>
            <li><a href="chapter5.html">ç¬¬5ç« </a></li>
            <li><a href="chapter6.html">ç¬¬6ç« </a></li>
            <li><a href="chapter7.html">ç¬¬7ç« </a></li>
            <li><a href="chapter8.html" class="current">ç¬¬8ç« </a></li>
            <li><a href="chapter9.html">ç¬¬9ç« </a></li>
            <li><a href="chapter10.html">ç¬¬10ç« </a></li>
            <li><a href="chapter11.html">ç¬¬11ç« </a></li>
            <li><a href="chapter12.html">ç¬¬12ç« </a></li>
        </ul>
    </nav>
    
    <div class="container">
        <div class="chapter">
            <h2>ç¬¬8ç« ï¼šç‰©ç†è®¾è®¡</h2>
            
            <p>ç‰©ç†è®¾è®¡æ˜¯å°†RTLè®¾è®¡è½¬åŒ–ä¸ºå¯åˆ¶é€ èŠ¯ç‰‡ç‰ˆå›¾çš„å…³é”®æ­¥éª¤ã€‚å¯¹äºNPUè¿™æ ·çš„é«˜æ€§èƒ½ã€é«˜å¯†åº¦èŠ¯ç‰‡ï¼Œç‰©ç†è®¾è®¡é¢ä¸´ç€åŠŸè€—ã€æ€§èƒ½ã€é¢ç§¯ç­‰å¤šæ–¹é¢çš„æŒ‘æˆ˜ã€‚æœ¬ç« å°†è¯¦ç»†ä»‹ç»NPUç‰©ç†è®¾è®¡çš„å®Œæ•´æµç¨‹ã€å…³é”®æŠ€æœ¯å’Œä¼˜åŒ–æ–¹æ³•ã€‚</p>

            <h3>8.1 ç‰©ç†è®¾è®¡æµç¨‹æ¦‚è¿°</h3>
            
            <p>NPUçš„ç‰©ç†è®¾è®¡æµç¨‹æ¶µç›–ä»é€»è¾‘ç»¼åˆåˆ°ç‰ˆå›¾éªŒè¯çš„å®Œæ•´è¿‡ç¨‹ã€‚æ¯ä¸ªé˜¶æ®µéƒ½éœ€è¦åœ¨æ€§èƒ½ã€åŠŸè€—ã€é¢ç§¯ä¹‹é—´è¿›è¡Œç²¾ç»†çš„æƒè¡¡ï¼Œä»¥æ»¡è¶³è®¾è®¡ç›®æ ‡ã€‚</p>

            <h4>8.1.1 è®¾è®¡è¾“å…¥ä¸çº¦æŸ</h4>
            <div class="info-box">
                <p><strong>NPUç‰©ç†è®¾è®¡çš„è¾“å…¥ï¼š</strong></p>
                <ul>
                    <li><strong>RTLä»£ç å’Œç½‘è¡¨ï¼š</strong>ç»è¿‡ç»¼åˆåçš„é—¨çº§ç½‘è¡¨</li>
                    <li><strong>å·¥è‰ºåº“æ–‡ä»¶ï¼š</strong>
                        <ul>
                            <li><strong>.lib (Liberty)ï¼š</strong>å®šä¹‰å•å…ƒçš„æ—¶åºå’ŒåŠŸè€—ç‰¹æ€§ï¼ˆé€»è¾‘å±‚é¢ï¼‰</li>
                            <li><strong>.lef (Library Exchange Format)ï¼š</strong>å®šä¹‰å•å…ƒçš„ç‰©ç†ç‰ˆå›¾ä¿¡æ¯ï¼Œå¦‚å°ºå¯¸ã€å¼•è„šä½ç½®ï¼ˆç‰©ç†å±‚é¢ï¼‰</li>
                        </ul>
                    </li>
                    <li><strong>è®¾è®¡çº¦æŸï¼ˆSDCï¼‰ï¼š</strong>æ—¶åºã€åŠŸè€—ã€é¢ç§¯çº¦æŸ</li>
                    <li><strong>åŠŸè€—æ„å›¾ï¼ˆUPF/CPFï¼‰ï¼š</strong>å®šä¹‰ç”µæºåŸŸã€ç”µæºæ¨¡å¼ã€éš”ç¦»ç­–ç•¥</li>
                    <li><strong>ç‰©ç†çº¦æŸï¼ˆDEFï¼‰ï¼š</strong>èŠ¯ç‰‡å¸ƒå±€ã€å®å•å…ƒä½ç½®ç­‰ç‰©ç†ä¿¡æ¯</li>
                </ul>
            </div>

            <div class="code-block">
# å…¸å‹çš„NPUè®¾è®¡çº¦æŸç¤ºä¾‹ (SDC)
# æ—¶é’Ÿå®šä¹‰
create_clock -name sys_clk -period 1.0 [get_ports clk]
create_clock -name noc_clk -period 0.8 [get_ports noc_clk]

# æ—¶é’Ÿä¸ç¡®å®šæ€§
set_clock_uncertainty -setup 0.05 [get_clocks sys_clk]
set_clock_uncertainty -hold 0.03 [get_clocks sys_clk]

# è¾“å…¥/è¾“å‡ºå»¶è¿Ÿ
set_input_delay -clock sys_clk -max 0.2 [all_inputs]
set_output_delay -clock sys_clk -max 0.15 [all_outputs]

# å¤šå‘¨æœŸè·¯å¾„ï¼ˆé’ˆå¯¹MACé˜µåˆ—ï¼‰
# ä¸ºä»€ä¹ˆï¼šMACæ“ä½œæœ¬èº«éœ€è¦å¤šä¸ªå‘¨æœŸå®Œæˆï¼Œå¼ºåˆ¶å•å‘¨æœŸä¼šå¯¼è‡´æ—¶åºè¿‡ç´§
set_multicycle_path -setup 2 -from [get_pins mac_array/*/mult_reg*] \
                    -to [get_pins mac_array/*/acc_reg*]

# ä¼ªè·¯å¾„ï¼ˆè·¨æ—¶é’ŸåŸŸï¼‰
set_false_path -from [get_clocks sys_clk] -to [get_clocks noc_clk]

# æœ€å¤§è¿‡æ¸¡æ—¶é—´å’Œç”µå®¹
set_max_transition 0.1 [current_design]
set_max_capacitance 0.05 [all_outputs]
            </div>

            <h4>8.1.2 ç‰©ç†è®¾è®¡ä¸»è¦æ­¥éª¤</h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾è®¡é˜¶æ®µ</th>
                            <th>ä¸»è¦ä»»åŠ¡</th>
                            <th>å…³é”®æŒ‡æ ‡</th>
                            <th>NPUç‰¹æ®Šè€ƒè™‘</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Floorplan</td>
                            <td>èŠ¯ç‰‡å¸ƒå±€è§„åˆ’</td>
                            <td>åˆ©ç”¨ç‡ã€å¼•è„šåˆ†é…</td>
                            <td>MACé˜µåˆ—è§„åˆ™å¸ƒå±€</td>
                        </tr>
                        <tr>
                            <td>Power Planning</td>
                            <td>ç”µæºç½‘ç»œè®¾è®¡</td>
                            <td>IR Dropã€EM</td>
                            <td>é«˜åŠŸè€—å¯†åº¦åŒºåŸŸ</td>
                        </tr>
                        <tr>
                            <td>Placement</td>
                            <td>æ ‡å‡†å•å…ƒå¸ƒå±€</td>
                            <td>æ‹¥å¡åº¦ã€æ—¶åº</td>
                            <td>æ•°æ®é€šè·¯å¯¹é½</td>
                        </tr>
                        <tr>
                            <td>CTS</td>
                            <td>æ—¶é’Ÿæ ‘ç»¼åˆ</td>
                            <td>Skewã€åŠŸè€—</td>
                            <td>å¤šæ—¶é’ŸåŸŸå¤„ç†</td>
                        </tr>
                        <tr>
                            <td>Routing</td>
                            <td>ä¿¡å·çº¿å¸ƒçº¿</td>
                            <td>DRCã€æ—¶åºæ”¶æ•›</td>
                            <td>é«˜å¯†åº¦äº’è¿</td>
                        </tr>
                        <tr>
                            <td>Sign-off</td>
                            <td>æœ€ç»ˆéªŒè¯</td>
                            <td>æ—¶åºã€åŠŸè€—ã€DRC</td>
                            <td>å…¨èŠ¯ç‰‡éªŒè¯</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>8.2 å¸ƒå±€è§„åˆ’ï¼ˆFloorplanï¼‰</h3>
            
            <p>å¸ƒå±€è§„åˆ’æ˜¯ç‰©ç†è®¾è®¡çš„ç¬¬ä¸€æ­¥ï¼Œå†³å®šäº†èŠ¯ç‰‡çš„æ•´ä½“æ¶æ„å’Œæ€§èƒ½ä¸Šé™ã€‚å¯¹äºNPUï¼Œåˆç†çš„å¸ƒå±€è§„åˆ’å¯¹äºå®ç°é«˜æ€§èƒ½å’Œä½åŠŸè€—è‡³å…³é‡è¦ã€‚</p>

            <h4>8.2.1 NPUå…¸å‹å¸ƒå±€æ¶æ„</h4>
            <div class="code-block">
// NPUèŠ¯ç‰‡å…¸å‹å¸ƒå±€
+----------------------------------------------------------+
|                      IO Ring / Pad                       |
|  +--------------------------------------------------+    |
|  |          Global Control & Configuration          |    |
|  +--------------------------------------------------+    |
|  |                                                  |    |
|  |   +----------+  +----------+  +----------+      |    |
|  |   | MAC      |  | MAC      |  | MAC      | ... |    |
|  |   | Cluster  |  | Cluster  |  | Cluster  |     |    |
|  |   | 0        |  | 1        |  | 2        |     |    |
|  |   +----------+  +----------+  +----------+      |    |
|  |                                                  |    |
|  |   +---------------------------------------+      |    |
|  |   |          Global SRAM Buffer          |      |    |
|  |   +---------------------------------------+      |    |
|  |                                                  |    |
|  |   +----------+  +----------+  +----------+      |    |
|  |   | NoC      |  | DMA      |  | Memory   |     |    |
|  |   | Router   |  | Engine   |  | Control  |     |    |
|  |   +----------+  +----------+  +----------+      |    |
|  |                                                  |    |
|  +--------------------------------------------------+    |
|                      IO Ring / Pad                       |
+----------------------------------------------------------+
            </div>

            <h4>8.2.2 å¸ƒå±€ä¼˜åŒ–ç­–ç•¥</h4>
            <div class="warning-box">
                <p><strong>NPUå¸ƒå±€çš„å…³é”®æŒ‘æˆ˜ï¼š</strong></p>
                <ul>
                    <li>MACé˜µåˆ—çš„è§„åˆ™æ€§å¸ƒå±€è¦æ±‚</li>
                    <li>é«˜å¸¦å®½æ•°æ®é€šè·¯çš„å¸ƒçº¿èµ„æº</li>
                    <li>åŠŸè€—å¯†åº¦çš„å‡åŒ€åˆ†å¸ƒ</li>
                    <li>æ—¶é’ŸåŸŸçš„ç‰©ç†éš”ç¦»</li>
                </ul>
            </div>

            <div class="code-block">
# Floorplan TCLè„šæœ¬ç¤ºä¾‹
# è®¾ç½®èŠ¯ç‰‡å°ºå¯¸å’Œåˆ©ç”¨ç‡
create_floorplan -die_size {0 0 5000 5000} \
                 -core_offset {100 100 100 100} \
                 -utilization 0.7

# åˆ›å»ºç”µå‹åŸŸ
create_voltage_area -name CORE_PD -coordinate {500 500 4500 4500}
create_voltage_area -name AON_PD -coordinate {100 100 500 4900}

# æ”¾ç½®ç¡¬å®ï¼ˆHard Macroï¼‰
# MACé›†ç¾¤è§„åˆ™æ’åˆ—
set mac_width 800
set mac_height 600
set mac_spacing 50

for {set i 0} {$i < 8} {incr i} {
    for {set j 0} {$j < 8} {incr j} {
        set x_loc [expr 600 + $i * ($mac_width + $mac_spacing)]
        set y_loc [expr 600 + $j * ($mac_height + $mac_spacing)]
        create_macro_placement -inst_name mac_cluster_${i}_${j} \
                             -coordinate [list $x_loc $y_loc] \
                             -orientation N
    }
}

# æ”¾ç½®SRAM
create_macro_placement -inst_name global_buffer_sram \
                      -coordinate {1500 3500} \
                      -orientation N

# åˆ›å»ºplacement blockage
# ç›®çš„ï¼šåœ¨MACé˜µåˆ—åŒºåŸŸå†…é˜»æ­¢æ ‡å‡†å•å…ƒçš„è‡ªåŠ¨å¸ƒå±€ï¼Œ
# ä¸ºåç»­æ‰‹åŠ¨æˆ–åŠè‡ªåŠ¨çš„æ•°æ®é€šè·¯å¸ƒçº¿é¢„ç•™ç©ºé—´
create_placement_blockage -name mac_blockage \
                         -type hard \
                         -coordinate {600 600 4400 3400}

# è®¾ç½®Haloï¼ˆç¡¬å®å‘¨å›´çš„ç¦å¸ƒåŒºï¼‰
# ç›®çš„ï¼šé˜²æ­¢æ ‡å‡†å•å…ƒç´§è´´ç¡¬å®æ”¾ç½®
# 1. é¿å…ç¡¬å®å¼•è„šé™„è¿‘çš„å¸ƒçº¿æ‹¥å¡
# 2. ä¸ºç¡¬å®çš„ç”µæºè¿æ¥å’Œä¿¡å·ç¼“å†²æä¾›ç©ºé—´
create_keepout_margin -type hard -outer {20 20 20 20} \
                     [get_cells -hier -filter "is_hard_macro==true"]
            </div>

            <h3>8.3 ç”µæºè§„åˆ’ä¸å®ç°</h3>
            
            <p>NPUçš„é«˜åŠŸè€—å¯†åº¦å¯¹ç”µæºç½‘ç»œè®¾è®¡æå‡ºäº†ä¸¥è‹›è¦æ±‚ã€‚è‰¯å¥½çš„ç”µæºè§„åˆ’ä¸ä»…å½±å“èŠ¯ç‰‡çš„åŠŸèƒ½æ­£ç¡®æ€§ï¼Œè¿˜ç›´æ¥å†³å®šäº†æ€§èƒ½å’Œå¯é æ€§ã€‚</p>

            <h4>8.3.1 ç”µæºç½‘æ ¼è®¾è®¡</h4>
            <div class="code-block">
# ç”µæºç½‘æ ¼è§„åˆ’è„šæœ¬
# å®šä¹‰ç”µæºç½‘ç»œ
create_net -power VDD
create_net -ground VSS

# åˆ›å»ºç”µæºç¯ï¼ˆPower Ringï¼‰
create_power_ring -nets {VDD VSS} \
                  -layers {M9 M10} \
                  -widths {20 20} \
                  -spacings {5 5} \
                  -core_offset 10

# åˆ›å»ºç”µæºæ¡å¸¦ï¼ˆPower Stripeï¼‰
# å‚ç›´æ¡å¸¦ - M9
create_power_stripes -nets {VDD VSS} \
                     -layer M9 \
                     -direction vertical \
                     -width 10 \
                     -spacing 5 \
                     -pitch 100 \
                     -start_x 100 \
                     -stop_x 4900

# æ°´å¹³æ¡å¸¦ - M10  
create_power_stripes -nets {VDD VSS} \
                     -layer M10 \
                     -direction horizontal \
                     -width 10 \
                     -spacing 5 \
                     -pitch 100 \
                     -start_y 100 \
                     -stop_y 4900

# MACé˜µåˆ—åŒºåŸŸåŠ å¯†ç”µæºç½‘æ ¼
create_power_stripes -nets {VDD VSS} \
                     -layer M9 \
                     -direction vertical \
                     -width 5 \
                     -spacing 2.5 \
                     -pitch 25 \
                     -region {600 600 4400 3400}
            </div>

            <h4>8.3.2 IR Dropåˆ†æä¸ä¼˜åŒ–</h4>
            <div class="info-box">
                <p><strong>IR Dropä¼˜åŒ–æŠ€æœ¯åŠåŸç†ï¼š</strong></p>
                <ol>
                    <li><strong>ç”µæºç½‘æ ¼åŠ å¯†ï¼š</strong>åœ¨é«˜åŠŸè€—åŒºåŸŸå¢åŠ ç”µæºæ¡å¸¦å¯†åº¦
                        <ul>
                            <li>åŸç†ï¼šé™ä½ç”µæµå¯†åº¦ï¼Œå‡å°‘IÃ—Rå‹é™</li>
                        </ul>
                    </li>
                    <li><strong>Viaé˜µåˆ—ä¼˜åŒ–ï¼š</strong>å¢åŠ å±‚é—´è¿æ¥viaæ•°é‡ï¼Œé™ä½ç”µé˜»
                        <ul>
                            <li>åŸç†ï¼šå¹¶è”viaé™ä½æ¥è§¦ç”µé˜»ï¼Œæ”¹å–„å‚ç›´æ–¹å‘ç”µæµè·¯å¾„</li>
                        </ul>
                    </li>
                    <li><strong>å»è€¦ç”µå®¹æ’å…¥ï¼š</strong>åœ¨ç©ºç™½åŒºåŸŸå¡«å……å»è€¦ç”µå®¹
                        <ul>
                            <li>åŸç†ï¼šå»è€¦ç”µå®¹åœ¨é«˜é¢‘å¼€å…³æ—¶æä¾›ç¬æ—¶ç”µæµï¼Œå¦‚åŒå¾®å‹"è“„æ°´æ± "ï¼Œç¨³å®šå±€éƒ¨ç”µæºç”µå‹</li>
                        </ul>
                    </li>
                    <li><strong>ç”µæºé—¨æ§ä¼˜åŒ–ï¼š</strong>åˆç†è§„åˆ’ç”µæºå¼€å…³ä½ç½®
                        <ul>
                            <li>åŸç†ï¼šå‡å°‘å…³æ–­åŒºåŸŸçš„æ¼ç”µæµï¼Œé™ä½æ€»ä½“åŠŸè€—</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <h3>8.4 å¸ƒå±€ä¼˜åŒ–ï¼ˆPlacementï¼‰</h3>
            
            <p>å¸ƒå±€é˜¶æ®µå°†æ ‡å‡†å•å…ƒå’Œå®å•å…ƒæ”¾ç½®åœ¨èŠ¯ç‰‡ä¸Šçš„åˆé€‚ä½ç½®ã€‚NPUçš„å¸ƒå±€ä¼˜åŒ–éœ€è¦ç‰¹åˆ«å…³æ³¨æ•°æ®é€šè·¯çš„è§„åˆ™æ€§å’Œæ—¶åºå…³é”®è·¯å¾„ã€‚</p>

            <h4>8.4.1 åˆ†å±‚å¸ƒå±€ç­–ç•¥</h4>
            <div class="code-block">
# å¸ƒå±€ä¼˜åŒ–è„šæœ¬
# è®¾ç½®å¸ƒå±€é€‰é¡¹
set_placement_options -congestion_effort high \
                     -timing_driven true \
                     -global_route_based true

# æ•°æ®é€šè·¯è§„åˆ™åŒ–å¸ƒå±€
# åˆ›å»ºç›¸å¯¹å¸ƒå±€çº¦æŸ
create_relative_placement -name mac_datapath \
                         -pattern {
                             {mult_stage_0 mult_stage_1 mult_stage_2}
                             {add_stage_0  add_stage_1  add_stage_2}
                             {acc_stage_0  acc_stage_1  acc_stage_2}
                         } \
                         -x_pitch 50 \
                         -y_pitch 40

# å…³é”®è·¯å¾„ä¼˜åŒ–
set_critical_path_groups -from [get_pins mac_array/*/data_in*] \
                        -to [get_pins mac_array/*/data_out*]

# æ‰§è¡Œå¸ƒå±€
place_design -concurrent_optimization \
            -incremental \
            -density_gradient

# å¸ƒå±€åä¼˜åŒ–
optimize_placement -critical_path \
                  -congestion \
                  -setup_target_slack 0.05
            </div>

            <h4>8.4.2 æ‹¥å¡åˆ†æä¸ç¼“è§£</h4>
            <div class="warning-box">
                <p><strong>NPUå¸ƒå±€å¸¸è§æ‹¥å¡é—®é¢˜ï¼š</strong></p>
                <ul>
                    <li>MACé˜µåˆ—é—´çš„å¯†é›†äº’è¿</li>
                    <li>æ§åˆ¶ä¿¡å·çš„æ‰‡å‡ºè¿‡å¤§</li>
                    <li>æ•°æ®æ€»çº¿çš„å¸ƒçº¿èµ„æºç«äº‰</li>
                    <li>æ—¶é’Ÿç½‘ç»œä¸ä¿¡å·çº¿çš„å†²çª</li>
                </ul>
            </div>

            <h3>8.5 æ—¶é’Ÿæ ‘ç»¼åˆï¼ˆCTSï¼‰</h3>
            
            <p>æ—¶é’Ÿæ ‘ç»¼åˆæ˜¯ç¡®ä¿æ—¶åºæ”¶æ•›çš„å…³é”®æ­¥éª¤ã€‚NPUé€šå¸¸åŒ…å«å¤šä¸ªæ—¶é’ŸåŸŸï¼Œéœ€è¦ç²¾å¿ƒè®¾è®¡æ—¶é’Ÿæ ‘ç»“æ„ä»¥æœ€å°åŒ–æ—¶é’Ÿåæ–œå’ŒåŠŸè€—ã€‚</p>

            <h4>8.5.1 æ—¶é’Ÿæ ‘è§„åˆ’</h4>
            <div class="code-block">
# CTSé…ç½®è„šæœ¬
# å®šä¹‰æ—¶é’Ÿæ ‘çº¦æŸ
create_clock_tree_spec -name clk_spec \
                      -period 1.0 \
                      -root_pin clk \
                      -leaf_pins [get_pins -hier */clk] \
                      -buffers {CKBUF_X16 CKBUF_X32} \
                      -inverters {CKINV_X16 CKINV_X32}

# è®¾ç½®æ—¶é’Ÿæ ‘ç›®æ ‡
set_clock_tree_options -target_skew 0.02 \
                      -target_latency 0.3 \
                      -max_transition 0.08 \
                      -max_capacitance 0.1

# å¤šæ—¶é’ŸåŸŸå¤„ç†
foreach clk [get_clocks] {
    set_clock_tree_options -clock $clk \
                          -routing_rule clk_routing_rule \
                          -use_inverters true \
                          -buffer_sizing true
}

# æ—¶é’Ÿé—¨æ§æ„ŸçŸ¥CTS
set_clock_gating_options -max_fanout 32 \
                        -min_bitwidth 8

# æ‰§è¡ŒCTS
clock_tree_synthesis -propagate_all_clocks \
                    -timing_driven \
                    -balance_groups
            </div>

            <h4>8.5.2 æ—¶é’ŸåŸŸäº¤å‰ï¼ˆCDCï¼‰å¤„ç†</h4>
            <div class="code-block">
// CDCåŒæ­¥å™¨è®¾è®¡
module cdc_sync #(
    parameter WIDTH = 1,
    parameter SYNC_STAGES = 2
)(
    input wire src_clk,
    input wire dst_clk,
    input wire src_rst_n,
    input wire dst_rst_n,
    input wire [WIDTH-1:0] src_data,
    output reg [WIDTH-1:0] dst_data
);
    
    // å¤šçº§åŒæ­¥å™¨
    reg [WIDTH-1:0] sync_regs[SYNC_STAGES-1:0];
    
    // ç›®æ ‡æ—¶é’ŸåŸŸåŒæ­¥
    always @(posedge dst_clk or negedge dst_rst_n) begin
        if (!dst_rst_n) begin
            for (int i = 0; i < SYNC_STAGES; i++) begin
                sync_regs[i] <= '0;
            end
            dst_data <= '0;
        end else begin
            sync_regs[0] <= src_data;
            for (int i = 1; i < SYNC_STAGES; i++) begin
                sync_regs[i] <= sync_regs[i-1];
            end
            dst_data <= sync_regs[SYNC_STAGES-1];
        end
    end
    
    // æ—¶åºçº¦æŸ
    // synthesis attribute ASYNC_REG of sync_regs is TRUE
    // ä½œç”¨ï¼šå‘Šè¯‰ç»¼åˆå·¥å…·ä¸è¦å¯¹åŒæ­¥å¯„å­˜å™¨è¿›è¡Œé€»è¾‘ä¼˜åŒ–ï¼Œ
    // ä»¥ä¿è¯äºšç¨³æ€çš„æœ‰æ•ˆè¿‡æ»¤
    
endmodule

// æ³¨æ„ï¼šå¯¹äºå¤šä½æ•°æ®æ€»çº¿ï¼Œç®€å•çš„å¤šçº§åŒæ­¥å™¨å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
// é€šå¸¸éœ€è¦ä½¿ç”¨å¼‚æ­¥FIFOæˆ–æ¡æ‰‹åè®®è¿›è¡Œæ›´å¯é çš„è·¨æ—¶é’ŸåŸŸä¼ è¾“
            </div>

            <h3>8.6 å¸ƒçº¿ä¸ä¼˜åŒ–ï¼ˆRoutingï¼‰</h3>
            
            <p>å¸ƒçº¿é˜¶æ®µå®Œæˆæ‰€æœ‰ä¿¡å·çš„ç‰©ç†è¿æ¥ã€‚NPUçš„é«˜å¯†åº¦å’Œé«˜æ€§èƒ½è¦æ±‚ä½¿å¾—å¸ƒçº¿å˜å¾—æå…·æŒ‘æˆ˜æ€§ï¼Œéœ€è¦é‡‡ç”¨å…ˆè¿›çš„å¸ƒçº¿ç­–ç•¥å’Œä¼˜åŒ–æŠ€æœ¯ã€‚</p>

            <h4>8.6.1 å…¨å±€å¸ƒçº¿ç­–ç•¥</h4>
            <div class="code-block">
# å¸ƒçº¿é…ç½®è„šæœ¬
# è®¾ç½®å¸ƒçº¿è§„åˆ™
define_routing_rule high_speed_rule \
                   -widths {M1:0.1 M2:0.1 M3:0.15 M4:0.15 M5:0.2 M6:0.2} \
                   -spacings {M1:0.1 M2:0.1 M3:0.15 M4:0.15 M5:0.2 M6:0.2} \
                   -vias {VIA12_FAT VIA23_FAT VIA34_FAT}

# å…³é”®ä¿¡å·å¸ƒçº¿çº¦æŸ
set_net_routing_rule [get_nets -of [get_pins mac_array/*/clk]] \
                     high_speed_rule

# è®¾ç½®å¸ƒçº¿é€‰é¡¹
set_route_options -groute_timing_driven true \
                  -groute_incremental true \
                  -track_assign_timing_driven true \
                  -droute_ECO_mode true

# å±è”½å±‚è®¾ç½®ï¼ˆé’ˆå¯¹å™ªå£°æ•æ„Ÿä¿¡å·ï¼‰
create_shield -nets {clk rst_n} \
              -with_net VSS \
              -side_spacing 0.2

# æ‰§è¡Œå…¨å±€å¸ƒçº¿
route_global -congestion_map_only false \
            -timing_driven true \
            -effort_level high

# è¯¦ç»†å¸ƒçº¿
route_detail -incremental true \
            -timing_driven true \
            -si_driven true
            </div>

            <h4>8.6.2 ä¿¡å·å®Œæ•´æ€§ä¼˜åŒ–</h4>
            <div class="info-box">
                <p><strong>SIä¼˜åŒ–æŠ€æœ¯ï¼š</strong></p>
                <ol>
                    <li><strong>ä¸²æ‰°é¿å…ï¼š</strong>å¢åŠ å…³é”®ä¿¡å·é—´è·</li>
                    <li><strong>å±è”½æ’å…¥ï¼š</strong>åœ¨æ•æ„Ÿä¿¡å·ä¸¤ä¾§æ·»åŠ åœ°çº¿å±è”½</li>
                    <li><strong>é©±åŠ¨ä¼˜åŒ–ï¼š</strong>è°ƒæ•´é©±åŠ¨å¼ºåº¦å‡å°‘å™ªå£°</li>
                    <li><strong>æ—¶åºä¿®å¤ï¼š</strong>è€ƒè™‘SIå½±å“çš„æ—¶åºä¼˜åŒ–</li>
                </ol>
            </div>

            <h3>8.7 ç‰©ç†éªŒè¯ä¸ç­¾æ”¶</h3>
            
            <p>ç‰©ç†éªŒè¯ç¡®ä¿è®¾è®¡æ»¡è¶³æ‰€æœ‰åˆ¶é€ è§„åˆ™å’Œæ€§èƒ½è¦æ±‚ã€‚è¿™æ˜¯æµç‰‡å‰çš„æœ€åå…³å¡ï¼Œå¿…é¡»ä¸¥æ ¼æŠŠå…³ã€‚</p>

            <h4>8.7.1 DRC/LVSæ£€æŸ¥</h4>
            <div class="code-block">
# DRCæ£€æŸ¥è„šæœ¬
# åŠ è½½è§„åˆ™æ–‡ä»¶
load_tech_file ./tech/drc_rules.tf

# è¿è¡ŒDRC
run_drc -cell TOP \
        -report drc_report.txt \
        -error_view drc_errors

# å¸¸è§DRCè¿ä¾‹ç±»å‹
# 1. æœ€å°å®½åº¦è¿ä¾‹ (Min Width)
# 2. æœ€å°é—´è·è¿ä¾‹ (Min Spacing)  
# 3. æœ€å°é¢ç§¯è¿ä¾‹ (Min Area)
# 4. Viaè¦†ç›–è¿ä¾‹ (Via Enclosure)
# 5. å¯†åº¦è¿ä¾‹ (Density)
# 6. å¤©çº¿æ•ˆåº”è¿ä¾‹ (Antenna Rule)

# LVSæ£€æŸ¥
run_lvs -schematic ../netlist/npu_top.v \
        -layout ./npu_top.gds \
        -report lvs_report.txt \
        -extract_rc true

# å¤©çº¿æ•ˆåº”æ£€æŸ¥ä¸ä¿®å¤
check_antenna -report antenna_report.txt
# ä¿®å¤æ–¹æ³•ï¼šæ’å…¥antenna diodeæˆ–jumper

# ç”µè¿ç§»ä¸IR Dropç­¾æ”¶
# ä½¿ç”¨ä¸“ç”¨å·¥å…·ï¼ˆå¦‚Voltus/RedHawkï¼‰è¿›è¡Œå…¨èŠ¯ç‰‡åˆ†æ
run_em_ir_analysis -tool voltus \
                   -mode {normal turbo sleep} \
                   -report em_ir_signoff.rpt
            </div>

            <h4>8.7.2 æ—¶åºç­¾æ”¶</h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>æ£€æŸ¥é¡¹ç›®</th>
                            <th>ç›®æ ‡å€¼</th>
                            <th>æ£€æŸ¥æ–¹æ³•</th>
                            <th>ä¿®å¤ç­–ç•¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Setupæ—¶åº</td>
                            <td>slack > 0</td>
                            <td>STAåˆ†æ</td>
                            <td>æ’å…¥bufferã€è°ƒæ•´å°ºå¯¸</td>
                        </tr>
                        <tr>
                            <td>Holdæ—¶åº</td>
                            <td>slack > 0</td>
                            <td>STAåˆ†æ</td>
                            <td>æ’å…¥delay buffer</td>
                        </tr>
                        <tr>
                            <td>è½¬æ¢æ—¶é—´</td>
                            <td>< 100ps</td>
                            <td>Transitionæ£€æŸ¥</td>
                            <td>è°ƒæ•´é©±åŠ¨å¼ºåº¦</td>
                        </tr>
                        <tr>
                            <td>æ—¶é’Ÿåæ–œ</td>
                            <td>< 20ps</td>
                            <td>æ—¶é’ŸæŠ¥å‘Š</td>
                            <td>CTSé‡æ–°å¹³è¡¡</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>8.8 ä½åŠŸè€—ç‰©ç†è®¾è®¡</h3>
            
            <p>NPUçš„åŠŸè€—ä¼˜åŒ–è´¯ç©¿æ•´ä¸ªç‰©ç†è®¾è®¡æµç¨‹ã€‚ä»æ¶æ„çº§åˆ°æ™¶ä½“ç®¡çº§ï¼Œæ¯ä¸ªå±‚æ¬¡éƒ½æœ‰ç›¸åº”çš„ä¼˜åŒ–æŠ€æœ¯ã€‚</p>

            <h4>8.8.1 å¤šé˜ˆå€¼ç”µå‹ä¼˜åŒ–</h4>
            <div class="code-block">
# å¤šVtä¼˜åŒ–è„šæœ¬
# å®šä¹‰Vtç±»å‹
set_attribute [get_libs */LVT] default_threshold_voltage_group LVT
set_attribute [get_libs */RVT] default_threshold_voltage_group RVT  
set_attribute [get_libs */HVT] default_threshold_voltage_group HVT

# è®¾ç½®ä¼˜åŒ–ç­–ç•¥
set_power_optimization_options -leakage_power true \
                              -dynamic_power true \
                              -total_power true

# Vtåˆ†é…ç­–ç•¥
# å…³é”®è·¯å¾„ä½¿ç”¨LVT
set_threshold_voltage_group [get_cells -of [all_critical_paths]] LVT

# éå…³é”®è·¯å¾„ä½¿ç”¨HVT
set_threshold_voltage_group [get_cells -of [all_non_critical_paths]] HVT

# æ‰§è¡ŒåŠŸè€—ä¼˜åŒ–
optimize_power -multi_vt \
               -size_only false \
               -preserve_paths [all_critical_paths]
            </div>

            <h4>8.8.2 ç”µæºé—¨æ§å®ç°</h4>
            
            <p>ç”µæºé—¨æ§é€šè¿‡åˆ‡æ–­ç©ºé—²æ¨¡å—çš„ç”µæºæ¥é™ä½æ¼ç”µåŠŸè€—ã€‚å…³é”®ç»„ä»¶åŒ…æ‹¬ï¼š</p>
            <ul>
                <li><strong>éš”ç¦»å•å…ƒï¼ˆIsolation Cellï¼‰ï¼š</strong>å½“æ¨¡å—æ–­ç”µæ—¶ï¼Œå°†å…¶è¾“å‡ºé’³ä½åˆ°ç¡®å®šçŠ¶æ€ï¼Œé˜²æ­¢ä¸ç¡®å®šä¿¡å·ä¼ æ’­</li>
                <li><strong>ç”µæºå¼€å…³ï¼ˆPower Switchï¼‰ï¼š</strong>ç”±ç‰¹æ®Šå¤§å°ºå¯¸MOSç®¡ç»„æˆï¼Œç”¨äºåˆ‡æ–­/æ¥é€šç”µæº</li>
                <li><strong>çŠ¶æ€ä¿æŒå¯„å­˜å™¨ï¼ˆRetention Registerï¼‰ï¼š</strong>ä¿å­˜å…³é”®çŠ¶æ€ï¼Œæ”¯æŒå¿«é€Ÿå”¤é†’</li>
            </ul>
            
            <div class="code-block">
// ç”µæºé—¨æ§æ§åˆ¶å™¨
// çŠ¶æ€è½¬æ¢é¡ºåºï¼šACTIVE -> ISOLATE -> POWER_DOWNï¼ˆå…ˆéš”ç¦»å†æ–­ç”µï¼‰
// å”¤é†’é¡ºåºï¼šPOWER_UP -> RESET -> WAKE_UPï¼ˆå…ˆä¸Šç”µå†æ’¤é”€éš”ç¦»ï¼‰
module power_gating_controller (
    input wire clk,
    input wire rst_n,
    input wire sleep_req,
    output reg sleep_ack,
    output reg isolate_n,
    output reg pwr_switch_n,
    output reg reset_n
);

    // çŠ¶æ€æœºå®šä¹‰
    typedef enum logic [2:0] {
        ACTIVE,
        ISOLATE,
        POWER_DOWN,
        SLEEP,
        POWER_UP,
        RESET,
        WAKE_UP
    } state_t;
    
    state_t current_state, next_state;
    
    // çŠ¶æ€è½¬æ¢
    always_ff @(posedge clk or negedge rst_n) begin
        if (!rst_n) begin
            current_state <= ACTIVE;
        end else begin
            current_state <= next_state;
        end
    end
    
    // çŠ¶æ€æœºé€»è¾‘
    always_comb begin
        next_state = current_state;
        
        case (current_state)
            ACTIVE: begin
                if (sleep_req) next_state = ISOLATE;
            end
            
            ISOLATE: begin
                next_state = POWER_DOWN;
            end
            
            POWER_DOWN: begin
                next_state = SLEEP;
            end
            
            SLEEP: begin
                if (!sleep_req) next_state = POWER_UP;
            end
            
            POWER_UP: begin
                next_state = RESET;
            end
            
            RESET: begin
                next_state = WAKE_UP;
            end
            
            WAKE_UP: begin
                next_state = ACTIVE;
            end
        endcase
    end
    
    // è¾“å‡ºæ§åˆ¶
    always_comb begin
        isolate_n = 1'b1;
        pwr_switch_n = 1'b0;
        reset_n = 1'b1;
        sleep_ack = 1'b0;
        
        case (current_state)
            ISOLATE: begin
                isolate_n = 1'b0;  // æ¿€æ´»éš”ç¦»
            end
            
            POWER_DOWN, SLEEP: begin
                isolate_n = 1'b0;
                pwr_switch_n = 1'b1;  // å…³é—­ç”µæº
                sleep_ack = 1'b1;
            end
            
            POWER_UP: begin
                isolate_n = 1'b0;
                pwr_switch_n = 1'b0;  // æ‰“å¼€ç”µæº
            end
            
            RESET: begin
                isolate_n = 1'b0;
                reset_n = 1'b0;  // å¤ä½
            end
        endcase
    end

endmodule
            </div>

            <h3>8.9 è®¾è®¡å¯æµ‹è¯•æ€§ï¼ˆDFTï¼‰</h3>
            
            <p>DFTæ˜¯ç‰©ç†è®¾è®¡ä¸­è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚æ²¡æœ‰è‰¯å¥½çš„DFTè®¾è®¡ï¼ŒèŠ¯ç‰‡å³ä½¿åˆ¶é€ å‡ºæ¥ä¹Ÿæ— æ³•æœ‰æ•ˆæµ‹è¯•ï¼Œæ— æ³•å®ç°é‡äº§ã€‚</p>

            <h4>8.9.1 æ‰«æé“¾è®¾è®¡</h4>
            <div class="code-block">
# æ‰«æé“¾æ’å…¥è„šæœ¬
# è®¾ç½®æ‰«æé“¾é…ç½®
set_scan_configuration -chain_count 32 \
                      -clock_mixing mix_clocks \
                      -add_lockup true \
                      -reorder true

# æ’å…¥æ‰«æé“¾
# åŸç†ï¼šå°†æ‰€æœ‰è§¦å‘å™¨ä¸²è”æˆç§»ä½å¯„å­˜å™¨é“¾
compile_scan

# æ‰«æé“¾é‡æ’åºï¼ˆå‡å°‘å¸ƒçº¿é•¿åº¦ï¼‰
# æ ¹æ®ç‰©ç†ä½ç½®ä¼˜åŒ–æ‰«æé“¾é¡ºåº
place_scan_chains -reorder \
                  -optimize_routing_length

# æ‰«æé“¾å¹³è¡¡
balance_scan_chains -max_length 500
            </div>

            <h4>8.9.2 å†…å»ºè‡ªæµ‹è¯•ï¼ˆBISTï¼‰</h4>
            <div class="info-box">
                <p><strong>NPUä¸­çš„BISTåº”ç”¨ï¼š</strong></p>
                <ul>
                    <li><strong>Memory BISTï¼š</strong>é’ˆå¯¹å¤§é‡ç‰‡ä¸ŠSRAMçš„æµ‹è¯•</li>
                    <li><strong>Logic BISTï¼š</strong>é’ˆå¯¹MACé˜µåˆ—ç­‰è§„åˆ™é€»è¾‘çš„æµ‹è¯•</li>
                    <li><strong>IO BISTï¼š</strong>é«˜é€Ÿæ¥å£çš„è‡ªæµ‹è¯•</li>
                </ul>
            </div>

            <div class="code-block">
// Memory BISTæ§åˆ¶å™¨ç¤ºä¾‹
module mbist_controller (
    input wire clk,
    input wire rst_n,
    input wire bist_en,
    output reg bist_done,
    output reg bist_fail,
    // å­˜å‚¨å™¨æ¥å£
    output reg [ADDR_WIDTH-1:0] mem_addr,
    output reg [DATA_WIDTH-1:0] mem_wdata,
    output reg mem_we,
    output reg mem_ce,
    input wire [DATA_WIDTH-1:0] mem_rdata
);
    
    // BISTç®—æ³•ï¼šMarch C-
    // { â‡‘(w0); â‡‘(r0,w1); â‡‘(r1,w0); 
    //   â‡“(r0,w1); â‡“(r1,w0); â‡‘(r0) }
    
    reg [2:0] phase;
    reg [ADDR_WIDTH-1:0] addr_cnt;
    reg up_direction;
    
    always @(posedge clk or negedge rst_n) begin
        if (!rst_n) begin
            phase <= 0;
            addr_cnt <= 0;
            bist_done <= 0;
            bist_fail <= 0;
        end else if (bist_en) begin
            // March C- ç®—æ³•å®ç°
            case (phase)
                0: begin // â‡‘(w0)
                    mem_we <= 1;
                    mem_wdata <= 0;
                    if (addr_cnt == MAX_ADDR) begin
                        phase <= 1;
                        addr_cnt <= 0;
                    end else begin
                        addr_cnt <= addr_cnt + 1;
                    end
                end
                // ... å…¶ä»–phases
            endcase
        end
    end
endmodule
            </div>

            <h4>8.9.3 å…ˆè¿›å·¥è‰ºèŠ‚ç‚¹çš„æŒ‘æˆ˜</h4>
            
            <p>7nmåŠä»¥ä¸‹å·¥è‰ºç»™ç‰©ç†è®¾è®¡å¸¦æ¥äº†æ–°çš„æŒ‘æˆ˜ï¼š</p>
            
            <div class="info-box">
                <p><strong>FinFET/GAAå·¥è‰ºå½±å“ï¼š</strong></p>
                <ul>
                    <li><strong>ç¦»æ•£å•å…ƒé«˜åº¦ï¼š</strong>æ ‡å‡†å•å…ƒé«˜åº¦å¿…é¡»æ˜¯é³ç‰‡é—´è·çš„æ•´æ•°å€</li>
                    <li><strong>å¼•è„šä½ç½®å—é™ï¼š</strong>å¼•è„šåªèƒ½æ”¾åœ¨ç‰¹å®šè½¨é“ä¸Š</li>
                    <li><strong>å¤šé‡æ›å…‰ï¼ˆMulti-Patterningï¼‰ï¼š</strong>éœ€è¦é¢œè‰²æ„ŸçŸ¥çš„å¸ƒå±€å¸ƒçº¿</li>
                    <li><strong>å¤æ‚DRCè§„åˆ™ï¼š</strong>è§„åˆ™æ•°é‡ä»28nmçš„æ•°åƒæ¡å¢åŠ åˆ°7nmçš„æ•°ä¸‡æ¡</li>
                </ul>
            </div>
            
            <h4>8.9.4 å°è£…ååŒè®¾è®¡</h4>
            
            <p>å¯¹äºé«˜æ€§èƒ½NPUï¼ŒèŠ¯ç‰‡è®¾è®¡å¿…é¡»ä¸å°è£…è®¾è®¡ç´§å¯†é…åˆï¼š</p>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾è®¡é˜¶æ®µ</th>
                            <th>å°è£…è€ƒè™‘</th>
                            <th>å½±å“</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>IOè§„åˆ’</td>
                            <td>å‡¸ç‚¹ï¼ˆBumpï¼‰åˆ†å¸ƒ</td>
                            <td>ä¿¡å·å®Œæ•´æ€§ã€ç”µæºåˆ†é…</td>
                        </tr>
                        <tr>
                            <td>ç”µæºè§„åˆ’</td>
                            <td>å°è£…åŸºæ¿PDN</td>
                            <td>IR Dropã€å»è€¦ç­–ç•¥</td>
                        </tr>
                        <tr>
                            <td>çƒ­è®¾è®¡</td>
                            <td>çƒ­ç•Œé¢ææ–™ï¼ˆTIMï¼‰</td>
                            <td>ç»“æ¸©ã€å¯é æ€§</td>
                        </tr>
                        <tr>
                            <td>é¡¶å±‚é‡‘å±</td>
                            <td>RDLå±‚è®¾è®¡</td>
                            <td>å‡¸ç‚¹é‡åˆ†å¸ƒ</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="exercise">
                <h4>ç»ƒä¹ é¢˜é›† 8</h4>
                
                <div class="question">
                    <p><strong>é¢˜ç›®8.1ï¼š</strong>æŸNPUèŠ¯ç‰‡é‡‡ç”¨7nmå·¥è‰ºï¼ŒèŠ¯ç‰‡é¢ç§¯100mmÂ²ï¼ŒåŠŸè€—50Wã€‚è®¡ç®—åŠŸè€—å¯†åº¦ï¼Œå¹¶åˆ†æå¯èƒ½çš„æ•£çƒ­æŒ‘æˆ˜ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šåŠŸè€—å¯†åº¦=æ€»åŠŸè€—/èŠ¯ç‰‡é¢ç§¯ã€‚å‚è€ƒå…¶ä»–å¤„ç†å™¨çš„åŠŸè€—å¯†åº¦ï¼ˆé€šå¸¸<0.3W/mmÂ²ï¼‰ã€‚è€ƒè™‘çƒ­ç‚¹ã€å°è£…ã€æ•£çƒ­æ–¹æ¡ˆã€å¯é æ€§å½±å“ç­‰å› ç´ ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <p>åŠŸè€—å¯†åº¦è®¡ç®—ï¼š</p>
                        <ul>
                            <li>åŠŸè€—å¯†åº¦ = 50W / 100mmÂ² = 0.5 W/mmÂ²</li>
                            <li>è¿™æ˜¯éå¸¸é«˜çš„åŠŸè€—å¯†åº¦ï¼Œæ¥è¿‘ç°ä»£å¤„ç†å™¨çš„æé™</li>
                        </ul>
                        <p>æ•£çƒ­æŒ‘æˆ˜ï¼š</p>
                        <ol>
                            <li><strong>çƒ­ç‚¹é—®é¢˜ï¼š</strong>MACé˜µåˆ—åŒºåŸŸå¯èƒ½å‡ºç°å±€éƒ¨çƒ­ç‚¹ï¼Œæ¸©åº¦å¯èƒ½è¶…è¿‡100Â°C</li>
                            <li><strong>å°è£…è¦æ±‚ï¼š</strong>éœ€è¦é«˜æ€§èƒ½å°è£…ï¼Œå¦‚flip-chip + çƒ­ç•Œé¢ææ–™</li>
                            <li><strong>æ•£çƒ­æ–¹æ¡ˆï¼š</strong>å¯èƒ½éœ€è¦ä¸»åŠ¨æ•£çƒ­ï¼ˆé£æ‰‡ï¼‰æˆ–æ¶²å†·</li>
                            <li><strong>å¯é æ€§å½±å“ï¼š</strong>é«˜æ¸©ä¼šåŠ é€Ÿç”µè¿ç§»ï¼Œå½±å“èŠ¯ç‰‡å¯¿å‘½</li>
                        </ol>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®8.2ï¼š</strong>è®¾è®¡ä¸€ä¸ªç®€å•çš„ç”µæºç½‘æ ¼ï¼Œä¸º16Ã—16çš„MACé˜µåˆ—ä¾›ç”µã€‚æ¯ä¸ªMACå•å…ƒåŠŸè€—100mWï¼Œç”µæºç”µå‹0.8Vã€‚å‡è®¾ä½¿ç”¨M9å’ŒM10å±‚æ„å»ºç”µæºç½‘æ ¼ï¼Œé‡‘å±å±‚çš„æœ€å¤§ç”µæµå¯†åº¦ä¸º1mA/Î¼mã€‚è¯·ä¼°ç®—åœ¨MACé˜µåˆ—åŒºåŸŸï¼ŒM9å±‚å‚ç›´ç”µæºæ¡å¸¦çš„æ€»æˆªé¢å®½åº¦éœ€è¦è¾¾åˆ°å¤šå°‘ï¼Œæ‰èƒ½æ»¡è¶³æ€»ç”µæµéœ€æ±‚ï¼Ÿå¹¶è®¨è®ºä¸ºä»€ä¹ˆå®é™…è®¾è®¡ä¸­éœ€è¦è¿œå¤§äºè¿™ä¸ªä¼°ç®—å€¼ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šå…ˆè®¡ç®—æ€»ç”µæµ(I=P/V)ã€‚ç”µæµå¯†åº¦é™åˆ¶å†³å®šäº†æœ€å°é‡‘å±å®½åº¦ã€‚å®é™…è®¾è®¡éœ€è¦è€ƒè™‘ç”µæµåˆ†å¸ƒä¸å‡ã€å³°å€¼ç”µæµã€IRå‹é™é™åˆ¶ã€å¯é æ€§è£•é‡ç­‰å› ç´ ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <p><strong>åŸºæœ¬è®¡ç®—ï¼š</strong></p>
                        <ol>
                            <li>æ€»åŠŸè€—ï¼š16 Ã— 16 Ã— 100mW = 25.6W</li>
                            <li>æ€»ç”µæµï¼šI = P/V = 25.6W / 0.8V = 32A</li>
                            <li>ç”µæµå¯†åº¦é™åˆ¶ï¼š1mA/Î¼m</li>
                            <li>ç†è®ºæœ€å°å®½åº¦ï¼š32A / 1mA/Î¼m = 32,000Î¼m = 32mm</li>
                        </ol>
                        
                        <p><strong>ä¸ºä»€ä¹ˆå®é™…è®¾è®¡éœ€è¦æ›´å¤§å®½åº¦ï¼š</strong></p>
                        <ol>
                            <li><strong>ç”µæµåˆ†å¸ƒä¸å‡ï¼š</strong>
                                <ul>
                                    <li>MACé˜µåˆ—ä¸­å¿ƒåŒºåŸŸç”µæµå¯†åº¦æ›´é«˜</li>
                                    <li>éœ€è¦2-3å€è£•é‡å¤„ç†å±€éƒ¨çƒ­ç‚¹</li>
                                </ul>
                            </li>
                            <li><strong>å³°å€¼ç”µæµè€ƒè™‘ï¼š</strong>
                                <ul>
                                    <li>å¼€å…³ç¬æ€ç”µæµå¯èƒ½æ˜¯å¹³å‡å€¼çš„2-5å€</li>
                                    <li>åŒæ—¶åˆ‡æ¢å™ªå£°ï¼ˆSSNï¼‰å½±å“</li>
                                </ul>
                            </li>
                            <li><strong>IRå‹é™é™åˆ¶ï¼š</strong>
                                <ul>
                                    <li>å…è®¸å‹é™é€šå¸¸<5% VDD = 40mV</li>
                                    <li>éœ€è¦æ›´ä½çš„ç”µé˜»ï¼Œæ„å‘³ç€æ›´å®½çš„é‡‘å±</li>
                                </ul>
                            </li>
                            <li><strong>å¯é æ€§è¦æ±‚ï¼š</strong>
                                <ul>
                                    <li>ç”µè¿ç§»å¯¿å‘½è¦æ±‚ï¼ˆ>10å¹´ï¼‰</li>
                                    <li>æ¸©åº¦é™é¢ï¼ˆderatingï¼‰</li>
                                </ul>
                            </li>
                        </ol>
                        
                        <p><strong>å®é™…è®¾è®¡ï¼š</strong>æ€»å®½åº¦å¯èƒ½éœ€è¦80-100mmï¼Œåˆ†å¸ƒåœ¨å¤šå±‚é‡‘å±å’Œç½‘æ ¼ç»“æ„ä¸­ã€‚</p>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®8.3ï¼š</strong>æŸNPUè®¾è®¡ä¸­ï¼Œå…³é”®è·¯å¾„å»¶è¿Ÿä¸º900psï¼Œå…¶ä¸­é€»è¾‘å»¶è¿Ÿ400psï¼Œäº’è¿å»¶è¿Ÿ500psã€‚å¦‚ä½•ä¼˜åŒ–ä»¥è¾¾åˆ°1GHzçš„ç›®æ ‡é¢‘ç‡ï¼Ÿ</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼š1GHzéœ€è¦è·¯å¾„å»¶è¿Ÿ<1000psã€‚äº’è¿å»¶è¿Ÿå æ¯”è¿‡é«˜ã€‚å¯ä»¥ä»<strong>ç‰©ç†å®ç°</strong>ï¼ˆæ’å…¥buffer/repeaterã€ä¼˜åŒ–å¸ƒå±€å‡å°‘çº¿é•¿ã€ä½¿ç”¨æ›´ä¼˜çš„å¸ƒçº¿å±‚ï¼‰å’Œ<strong>é€»è¾‘è®¾è®¡</strong>ï¼ˆåœ¨é•¿è·¯å¾„ä¸­æ’å…¥æµæ°´çº¿å¯„å­˜å™¨ï¼‰ä¸¤ä¸ªå±‚é¢è¿›è¡Œä¼˜åŒ–ã€‚è¯·åˆ†åˆ«è®¨è®ºä¸¤ç§æ–¹æ³•çš„ä¼˜ç¼ºç‚¹ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <p>å½“å‰æ—¶åºè£•é‡ï¼š1000ps - 900ps = 100psï¼ˆå·²æ»¡è¶³1GHzï¼‰</p>
                        <p>ä½†è£•é‡å¤ªå°ï¼Œå»ºè®®ä¼˜åŒ–ï¼š</p>
                        <ol>
                            <li><strong>é€»è¾‘ä¼˜åŒ–ï¼ˆå‡å°‘100psï¼‰ï¼š</strong>
                                <ul>
                                    <li>ä½¿ç”¨ä½Vtå•å…ƒæ›¿æ¢å…³é”®è·¯å¾„</li>
                                    <li>é€»è¾‘é‡æ„ï¼Œå‡å°‘çº§æ•°</li>
                                    <li>ä½¿ç”¨å¤åˆé—¨å‡å°‘å»¶è¿Ÿ</li>
                                </ul>
                            </li>
                            <li><strong>äº’è¿ä¼˜åŒ–ï¼ˆå‡å°‘150psï¼‰ï¼š</strong>
                                <ul>
                                    <li>å¢åŠ é©±åŠ¨bufferå°ºå¯¸</li>
                                    <li>ä½¿ç”¨æ›´é«˜é‡‘å±å±‚ï¼ˆä½ç”µé˜»ï¼‰</li>
                                    <li>æ’å…¥ä¸­ç»§å™¨ï¼ˆrepeaterï¼‰</li>
                                    <li>å‡å°‘çº¿é•¿ï¼ˆå¸ƒå±€ä¼˜åŒ–ï¼‰</li>
                                </ul>
                            </li>
                            <li><strong>ç›®æ ‡ï¼š</strong>æ€»å»¶è¿Ÿ650psï¼Œæ—¶åºè£•é‡350psï¼ˆ35%ï¼‰</li>
                        </ol>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®8.4ï¼š</strong>ç¼–å†™ä¸€ä¸ªç®€å•çš„æ—¶é’Ÿé—¨æ§å•å…ƒï¼ˆClock Gating Cellï¼‰ï¼Œå¹¶è¯´æ˜å…¶åœ¨NPUä¸­çš„åº”ç”¨ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šæ—¶é’Ÿé—¨æ§éœ€è¦é¿å…glitchã€‚ä½¿ç”¨latchæ¥ä¿æŒenableä¿¡å·åœ¨æ—¶é’Ÿä½ç”µå¹³æœŸé—´ç¨³å®šã€‚NPUä¸­å¯ä»¥å¯¹ç©ºé—²çš„MACå•å…ƒã€æœªä½¿ç”¨çš„å†…å­˜bankç­‰è¿›è¡Œé—¨æ§ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <div class="code-block">
module clock_gating_cell (
    input wire clk,
    input wire enable,
    input wire test_enable,  // DFTä¿¡å·
    output wire gclk
);
    
    reg enable_latch;
    
    // Latché˜²æ­¢æ¯›åˆº
    always @(clk or enable or test_enable) begin
        if (!clk) begin
            enable_latch <= enable | test_enable;
        end
    end
    
    // ANDé—¨è¾“å‡ºé—¨æ§æ—¶é’Ÿ
    assign gclk = clk & enable_latch;
    
    // ç»¼åˆæŒ‡ä»¤
    // synthesis attribute clock_gating_cell of clock_gating_cell is true
    
endmodule

// NPUä¸­çš„åº”ç”¨ç¤ºä¾‹
module mac_unit_with_cg (
    input wire clk,
    input wire rst_n,
    input wire enable,      // è®¡ç®—ä½¿èƒ½
    input wire [7:0] a,
    input wire [7:0] b,
    output reg [15:0] result
);
    
    wire gclk;
    
    // å®ä¾‹åŒ–æ—¶é’Ÿé—¨æ§
    clock_gating_cell cg_inst (
        .clk(clk),
        .enable(enable),
        .test_enable(1'b0),
        .gclk(gclk)
    );
    
    // ä½¿ç”¨é—¨æ§æ—¶é’Ÿ
    always @(posedge gclk or negedge rst_n) begin
        if (!rst_n) begin
            result <= 16'd0;
        end else begin
            result <= a * b;
        end
    end
    
endmodule
                        </div>
                        <p><strong>NPUåº”ç”¨åœºæ™¯ï¼š</strong></p>
                        <ul>
                            <li>MACé˜µåˆ—çš„åŠ¨æ€å…³æ–­ï¼šå½“æŸäº›MACå•å…ƒç©ºé—²æ—¶å…³é—­æ—¶é’Ÿ</li>
                            <li>å±‚çº§æ—¶é’Ÿé—¨æ§ï¼šæ•´ä¸ªè®¡ç®—ç°‡çš„æ—¶é’Ÿæ§åˆ¶</li>
                            <li>åŠŸè€—èŠ‚çœï¼šå¯èŠ‚çœ20-40%çš„åŠ¨æ€åŠŸè€—</li>
                        </ul>
                    </div>
                </div>

                <div class="question">
                    <p><strong>é¢˜ç›®8.5ï¼š</strong>åˆ†æå¹¶è®¾è®¡ä¸€ä¸ªNPUèŠ¯ç‰‡çš„IOè§„åˆ’ï¼Œéœ€è¦æ”¯æŒï¼šDDR4æ¥å£ï¼ˆ128ä½ï¼‰ã€PCIe Gen4 x16ã€åƒå…†ä»¥å¤ªç½‘ã€JTAGè°ƒè¯•ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šé«˜é€ŸIOï¼ˆDDR4ã€PCIeï¼‰éœ€è¦æ”¾åœ¨èŠ¯ç‰‡è¾¹ç¼˜å¹¶è€ƒè™‘ä¿¡å·å®Œæ•´æ€§ã€‚ä¸åŒç±»å‹çš„IOéœ€è¦ä¸åŒçš„ç”µæºåŸŸã€‚è€ƒè™‘å°è£…ç±»å‹å’Œå¼•è„šæ•°é‡ã€‚é«˜é€ŸIOéœ€è¦å·®åˆ†å¯¹å¸ƒçº¿ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        <p><strong>IOéœ€æ±‚åˆ†æï¼š</strong></p>
                        <table>
                            <tr>
                                <th>æ¥å£</th>
                                <th>ä¿¡å·æ•°é‡</th>
                                <th>IOç±»å‹</th>
                                <th>ä½ç½®å»ºè®®</th>
                            </tr>
                            <tr>
                                <td>DDR4-3200</td>
                                <td>~280 pins</td>
                                <td>SSTL</td>
                                <td>èŠ¯ç‰‡ä¸€ä¾§ï¼ˆæœ€çŸ­èµ°çº¿ï¼‰</td>
                            </tr>
                            <tr>
                                <td>PCIe Gen4 x16</td>
                                <td>~164 pins</td>
                                <td>å·®åˆ†å¯¹</td>
                                <td>é è¿‘è¾¹ç¼˜ï¼ˆæ˜“äºèµ°çº¿ï¼‰</td>
                            </tr>
                            <tr>
                                <td>åƒå…†ä»¥å¤ªç½‘</td>
                                <td>~16 pins</td>
                                <td>LVDS</td>
                                <td>ä»»æ„è§’è½</td>
                            </tr>
                            <tr>
                                <td>JTAG</td>
                                <td>5 pins</td>
                                <td>LVCMOS</td>
                                <td>ä¾¿äºè®¿é—®çš„ä½ç½®</td>
                            </tr>
                            <tr>
                                <td>ç”µæº/åœ°</td>
                                <td>~200 pins</td>
                                <td>Power</td>
                                <td>å‡åŒ€åˆ†å¸ƒ</td>
                            </tr>
                        </table>
                        
                        <p><strong>IOè§„åˆ’æ–¹æ¡ˆï¼š</strong></p>
                        <div class="code-block">
èŠ¯ç‰‡IOå¸ƒå±€ï¼ˆä¿¯è§†å›¾ï¼‰ï¼š
        North (DDR4æ¥å£)
     +-------------------+
     |  D D D ... D D D  |
     |D                 P|  East
West |D    NPU Core     C| (PCIe)
     |R                 I|
     |4                 e|
     |  G G J J J E E E  |
     +-------------------+
        South (GPIO/JTAG/Ethernet)

å¸ƒå±€åŸåˆ™ï¼š
1. DDR4æ”¾åŒ—ä¾§ï¼šæœ€çŸ­è·ç¦»åˆ°å†…å­˜æ§åˆ¶å™¨
2. PCIeæ”¾ä¸œä¾§ï¼šä¾¿äºæ¿çº§èµ°çº¿åˆ°æ’æ§½
3. ä½é€ŸIOæ”¾å—ä¾§ï¼šJTAGæ–¹ä¾¿è°ƒè¯•è®¿é—®
4. ç”µæºå‡åŒ€åˆ†å¸ƒå››å‘¨ï¼šé™ä½IR drop
                        </div>
                    </div>
                </div>
                
                <div class="question">
                    <p><strong>é¢˜ç›®8.6ï¼š</strong>åœ¨DRCæŠ¥å‘Šä¸­ï¼Œä½ å‘ç°äº†ä¸€ä¸ªæœ€å°é—´è·è¿ä¾‹ï¼ˆMin Spacing Violationï¼‰å’Œä¸€ä¸ªå¤©çº¿æ•ˆåº”è¿ä¾‹ï¼ˆAntenna Violationï¼‰ã€‚è¯·åˆ†åˆ«æè¿°è¿™ä¸¤ç§è¿ä¾‹çš„ç‰©ç†åŸå› ï¼Œå¹¶æå‡ºè‡³å°‘ä¸€ç§å¯èƒ½çš„ä¿®å¤æ–¹æ³•ã€‚</p>
                    <details class="hint">
                        <summary>ğŸ’¡ æç¤º</summary>
                        <p>æ€è€ƒæ–¹å‘ï¼šæœ€å°é—´è·è¿ä¾‹ä¸åˆ¶é€ å·¥è‰ºé™åˆ¶æœ‰å…³ã€‚å¤©çº¿æ•ˆåº”æ˜¯åˆ¶é€ è¿‡ç¨‹ä¸­çš„ç”µè·ç§¯ç´¯é—®é¢˜ã€‚ä¿®å¤æ–¹æ³•è¦è€ƒè™‘å¯¹è®¾è®¡çš„å½±å“æœ€å°åŒ–ã€‚</p>
                    </details>
                    <button class="toggle-answer">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <div class="answer">
                        <p><strong>ç­”æ¡ˆï¼š</strong></p>
                        
                        <p><strong>1. æœ€å°é—´è·è¿ä¾‹ï¼ˆMin Spacing Violationï¼‰ï¼š</strong></p>
                        <ul>
                            <li><strong>ç‰©ç†åŸå› ï¼š</strong>
                                <ul>
                                    <li>å…‰åˆ»åˆ†è¾¨ç‡é™åˆ¶ï¼šä¸¤æ¡çº¿å¤ªè¿‘ä¼šå¯¼è‡´çŸ­è·¯</li>
                                    <li>åˆ»èš€å·¥è‰ºé™åˆ¶ï¼šé—´è·å¤ªå°æ— æ³•å®Œå…¨åˆ»èš€</li>
                                    <li>å¯„ç”Ÿç”µå®¹è€ƒè™‘ï¼šé—´è·å½±å“ä¿¡å·ä¸²æ‰°</li>
                                </ul>
                            </li>
                            <li><strong>ä¿®å¤æ–¹æ³•ï¼š</strong>
                                <ul>
                                    <li>ç§»åŠ¨è¿ä¾‹çš„é‡‘å±çº¿ï¼Œå¢åŠ é—´è·</li>
                                    <li>æ”¹å˜å¸ƒçº¿å±‚ï¼Œä½¿ç”¨é—´è·è§„åˆ™æ›´å®½æ¾çš„å±‚</li>
                                    <li>å‡å°çº¿å®½ï¼ˆå¦‚æœä¸è¿åæœ€å°å®½åº¦è§„åˆ™ï¼‰</li>
                                    <li>ECOï¼ˆEngineering Change Orderï¼‰é‡æ–°å¸ƒçº¿</li>
                                </ul>
                            </li>
                        </ul>
                        
                        <p><strong>2. å¤©çº¿æ•ˆåº”è¿ä¾‹ï¼ˆAntenna Violationï¼‰ï¼š</strong></p>
                        <ul>
                            <li><strong>ç‰©ç†åŸå› ï¼š</strong>
                                <ul>
                                    <li>ç­‰ç¦»å­åˆ»èš€æ—¶ï¼Œé•¿é‡‘å±çº¿æ”¶é›†ç”µè·</li>
                                    <li>ç”µè·é€šè¿‡æ …ææ”¾ç”µï¼Œå¯èƒ½å‡»ç©¿æ°§åŒ–å±‚</li>
                                    <li>å¤©çº¿æ¯”ï¼ˆé‡‘å±é¢ç§¯/æ …æé¢ç§¯ï¼‰è¶…è¿‡é™åˆ¶</li>
                                </ul>
                            </li>
                            <li><strong>ä¿®å¤æ–¹æ³•ï¼š</strong>
                                <ul>
                                    <li><strong>æ’å…¥è·³çº¿ï¼ˆJumperï¼‰ï¼š</strong>å°†é•¿çº¿åˆ†æ®µï¼Œé€šè¿‡ä¸Šå±‚é‡‘å±è¿æ¥</li>
                                    <li><strong>æ·»åŠ å¤©çº¿äºŒæç®¡ï¼š</strong>æä¾›ç”µè·æ³„æ”¾è·¯å¾„</li>
                                    <li><strong>å¢åŠ æ …æé¢ç§¯ï¼š</strong>é™ä½å¤©çº¿æ¯”ï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰</li>
                                    <li><strong>æ”¹å˜å¸ƒçº¿è·¯å¾„ï¼š</strong>å‡å°‘è¿æ¥åˆ°æ …æçš„é‡‘å±é¢ç§¯</li>
                                </ul>
                            </li>
                        </ul>
                        
                        <div class="code-block">
// å¤©çº¿äºŒæç®¡æ’å…¥ç¤ºä¾‹
// åŸå§‹è¿æ¥ï¼šé•¿é‡‘å±çº¿ç›´æ¥è¿åˆ°æ …æ
wire long_metal_wire;
assign gate_signal = long_metal_wire;

// ä¿®å¤åï¼šæ·»åŠ ååäºŒæç®¡
wire long_metal_wire;
assign gate_signal = long_metal_wire;

// å¤©çº¿äºŒæç®¡ï¼ˆåœ¨å¸ƒå±€ä¸­è‡ªåŠ¨æ’å…¥ï¼‰
// antenna_diode ant_diode(.anode(gate_signal), .cathode(VSS));
                        </div>
                    </div>
                </div>
            </div>
        </section>
        </div>
        
        <div class="chapter-nav">
            <a href="chapter7.html" class="prev">ä¸Šä¸€ç« </a>
            <a href="chapter9.html" class="next">ä¸‹ä¸€ç« </a>
        </div>
    </div>
</body>
</html>